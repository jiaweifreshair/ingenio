version: '3.8'

services:
  # Chrome DevTools MCP Server
  chrome-devtools-mcp:
    build:
      context: ./chrome-devtools
      dockerfile: Dockerfile
    container_name: chrome-devtools-mcp
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - CHROME_PATH=/usr/bin/google-chrome-stable
      # 如果需要调试，可以启用verbose日志
      - DEBUG=chrome-devtools-mcp:*
    volumes:
      # 挂载Chrome用户数据目录（持久化浏览器状态）
      - chrome-user-data:/home/mcp/.config/google-chrome
      # 挂载下载目录
      - chrome-downloads:/home/mcp/Downloads
    # MCP通常使用stdio，不需要暴露端口
    # 但如果使用HTTP传输，可以暴露端口
    # ports:
    #   - "3000:3000"

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

    # 健康检查
    healthcheck:
      test: ["CMD", "pgrep", "-f", "chrome-devtools-mcp"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 安全选项（Chrome需要一些特权）
    security_opt:
      - seccomp:unconfined
    shm_size: '2gb'

    # 网络模式
    networks:
      - mcp-network

  # Figma MCP代理（如果需要本地代理）
  # figma-mcp-proxy:
  #   image: nginx:alpine
  #   container_name: figma-mcp-proxy
  #   restart: unless-stopped
  #   ports:
  #     - "8080:80"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #   networks:
  #     - mcp-network

  # Calicat MCP代理（如果需要本地代理）
  # calicat-mcp-proxy:
  #   image: nginx:alpine
  #   container_name: calicat-mcp-proxy
  #   restart: unless-stopped
  #   ports:
  #     - "8081:80"
  #   volumes:
  #     - ./nginx-calicat.conf:/etc/nginx/nginx.conf:ro
  #   networks:
  #     - mcp-network

# 数据卷
volumes:
  chrome-user-data:
    driver: local
  chrome-downloads:
    driver: local

# 网络
networks:
  mcp-network:
    driver: bridge
