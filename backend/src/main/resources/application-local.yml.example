# 本地开发环境配置
# ============================================================================
# ⚠️ 数据库连接规范 - 禁止使用本地PostgreSQL ⚠️
# ============================================================================
# 必须连接Docker容器中的PostgreSQL，禁止启动本地数据库服务
#
# 启动Docker服务：docker-compose up -d postgres redis minio
# 验证Docker数据库：docker ps | grep postgres
# 端口冲突排查：lsof -i :5432
# 停止本地数据库：brew services stop postgresql@15
# ============================================================================
spring:
  # 本地开发：自动加载项目根目录与 backend/ 目录下的 .env（不入库）
  # 目的：避免通过 IDE / mvn spring-boot:run 启动时忘记手动 source 导致密钥缺失（401 Invalid API Key）。
  # 说明：使用 `[.properties]` 强制按 properties 解析（.env 扩展名默认不被 Spring Boot 识别）。
  config:
    import:
      - optional:file:../.env[.properties]
      - optional:file:./.env[.properties]
      - optional:file:./backend/.env[.properties]

  # 数据源配置（连接Docker中的PostgreSQL）
  # ⚠️ localhost:5432 = Docker容器暴露的端口，不是本地PostgreSQL
  datasource:
    url: jdbc:postgresql://localhost:5432/ingenio?stringtype=unspecified
    username: ${DB_USER:postgres}
    password: ${DB_PASSWORD:ingenio_20251122}
    driver-class-name: org.postgresql.Driver

  # Redis配置（连接Docker中的Redis - 无密码）
  data:
    redis:
      host: 127.0.0.1
      port: 6379
      database: 0

  # 邮件配置（用于验证码发送）
  mail:
    host: ${MAIL_HOST:smtp.qq.com}
    port: ${MAIL_PORT:465}
    username: ${MAIL_USERNAME:your-email@qq.com}
    password: ${MAIL_PASSWORD:your-authorization-code}
    properties:
      mail:
        smtp:
          auth: true
          ssl:
            enable: true
          starttls:
            enable: false

  # Spring AI OpenAI配置（七牛云AI服务 - OpenAI兼容接口）
  # 注意：Spring AI 的 base-url 不要包含 /v1（例如 https://api.qnaigc.com）
  # 说明：Spring AI 会在 base-url 后自动拼接 `/v1/...`，若配置成 `.../v1` 会产生 `/v1/v1/...`（404）。
  ai:
    openai:
      # ⚠️ 请通过环境变量注入密钥，禁止在代码/配置中硬编码真实 sk-your-api-key... 值
      # 推荐：QINIU_CLOUD_API_KEY（七牛云 OpenAI 兼容接口）
      # 兼容：SPRING_AI_OPENAI_API_KEY / QINIU_AI_API_KEY / DEEPSEEK_API_KEY
      api-key: ${SPRING_AI_OPENAI_API_KEY:${QINIU_CLOUD_API_KEY:${QINIU_AI_API_KEY:${DEEPSEEK_API_KEY:sk-your-api-key}}}}
      # 注意：Spring AI 的 base-url 不要包含 /v1（例如 https://api.qnaigc.com）
      base-url: ${SPRING_AI_OPENAI_BASE_URL:${QINIU_CLOUD_BASE_URL:https://api.qnaigc.com}}
      chat:
        enabled: true
        options:
          # 使用 deepseek-v3 模型（七牛云推荐，RPM限制更宽松）
          # 可选模型（按RPM限制从宽到严排序）：
          # - deepseek-v3：代码和推理能力强，RPM限制相对宽松
          # - qwen-max：通义千问旗舰模型，适合复杂任务
          # - qwen-plus：性价比高，RPM限制宽松
          # - qwen3-235b-a22b-instruct-2507：235B大模型，RPM限制严格（2-5 RPM）
          model: deepseek-v3
          temperature: 0.3
          max-tokens: 4096
      embedding:
        enabled: false

# MinIO配置（连接Docker中的MinIO）
minio:
  endpoint: http://127.0.0.1:9000
  access-key: ${MINIO_ACCESS_KEY:minioadmin}
  secret-key: ${MINIO_SECRET_KEY:minioadmin}
  bucket-name: ingenio
  auto-create-bucket: true

# Redisson配置（无密码）
redisson:
  address: redis://localhost:6379
  # 不设置password字段，避免Redis认证错误
  database: 0
  connection-pool-size: 64
  connection-minimum-idle-size: 10
  idle-connection-timeout: 10000
  timeout: 3000

# SaToken JWT配置
sa-token:
  token-name: Authorization
  timeout: 604800 # Token总有效期：7天（秒）
  activity-timeout: 86400 # 活动超时：1天（秒）- 用户活跃时自动续期
  is-concurrent: true # 允许同一账号并发登录
  is-share: false # 不共享Token（每次登录生成新Token）
  token-style: jwt # 使用JWT风格Token
  is-log: true # 开启日志输出
  jwt-secret-key: ${JWT_SECRET_KEY:please-change-this-secret-key-min-32-characters}
  # 路由鉴权配置（Servlet Filter层 - 在Spring MVC拦截器之前执行）
  # 注意：这是SaToken的路由检查过滤器配置，需要与拦截器白名单保持一致
  check:
    # 排除的路径列表（无需认证）
    exclude-list:
      - /v1/auth/**
      - /v1/openlovable/**
      - /v1/generate/**
      - /v1/intent/**
      - /v2/**
      - /v1/prototype/**
      - /v1/notifications/unread-count
      - /swagger-ui/**
      - /swagger-ui.html
      - /v3/api-docs/**
      - /api-docs/**
      - /swagger-resources/**
      - /webjars/**
      - /actuator/**
      - /static/**
      - /public/**
      - /favicon.ico
      - /error
      # Admin API：由独立的服务间JWT保护，必须排除C端用户登录态校验
      - /admin/**
      - /api/admin/**

# 服务器配置
server:
  port: 8080
  servlet:
    context-path: /api
  compression:
    enabled: true

# 日志配置
logging:
  level:
    root: INFO
    com.ingenio.backend: DEBUG
    com.baomidou.mybatisplus: DEBUG
    org.springframework.ai: DEBUG
    com.alibaba.cloud.ai: DEBUG
    org.redisson: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# JeecgBoot多模态AI网关配置
# 架构说明：Ingenio -> JeecgBoot -> 七牛云AI
jeecgboot:
  api:
    base-url: ${JEECGBOOT_API_URL:http://localhost:7008}
    token: ${JEECGBOOT_API_TOKEN:}
    connect-timeout: 60000 # 连接超时：60秒
    read-timeout: 300000 # 读取超时：5分钟（AI生成可能较慢）
    write-timeout: 60000 # 写入超时：60秒

# Ingenio配置
ingenio:
  codegen:
    preview-base-url: http://localhost:3000

  # 租户配置
  tenant:
    default-tenant-id: 00000000-0000-0000-0000-000000000001

  # AI速率限制配置
  # 参考 open-lovable-cn 的实现：使用更合理的重试机制
  # deepseek-v3 模型的 RPM 限制相对宽松（约 30-60 RPM）
  ai:
    # Primary AI 配置（优先使用）：Claude via 本地代理
    primary:
      enabled: true
      base-url: http://127.0.0.1:8045/v1
      api-key: your-api-key-here
      model: claude-opus-4-5-thinking
    # 速率限制配置
    rate-limit:
      # 每分钟最大请求数：30 RPM（deepseek-v3 的限制约 60 RPM，留余量）
      rpm: 30
      # 最大并发请求数：3（避免同时发起过多请求）
      concurrent: 3
      # 两次调用之间的最小间隔：2秒
      min-interval-ms: 2000

  # Open-Lovable集成配置
  # Docker部署：3001端口（docker-compose映射3001:3000）
  # 本地开发：3001端口（确保3000端口未被占用）
  openlovable:
    base-url: ${OPENLOVABLE_BASE_URL:http://localhost:3001}

  # LangChain4j 配置覆盖（本地开发）
  g3:
    rag:
      engine: lc4j
    agent:
      engine: lc4j

  # LangChain4j 提供商配置（本地开发硬编码，避免环境变量问题）
  langchain4j:
    providers:
      uniaix:
        base-url: https://www.uniaix.com
        api-key: your-api-key-here
        embedding-model: doubao-embedding-text-240715
        embedding-dimension: 2048
      claude:
        base-url: https://aigateway.edgecloudapp.com/v1/6a346ca84941b743a3ea49cd6db8d004/xinbang01
        api-key: your-api-key-here
        model: claude-opus-4-5-20251101
        temperature: 0.2
        max-tokens: 12000
        timeout-seconds: 180
        max-retries: 2
      gemini:
        base-url: https://aigateway.edgecloudapp.com/v1/6a346ca84941b743a3ea49cd6db8d004/xinbang01
        api-key: your-api-key-here
        model: gemini-3-pro-high
        temperature: 0.2
        max-tokens: 6000
        timeout-seconds: 180
        max-retries: 2
      deepseek:
        base-url: https://api.qnaigc.com/v1
        api-key: your-api-key-here
        model: deepseek-r1-0528
        temperature: 0.2
        max-tokens: 6000
        timeout-seconds: 150
        max-retries: 2

  # 跨域配置（允许前端localhost:3000访问）
  cors:
    allowed-origins:
      - http://localhost:3000
      - http://127.0.0.1:3000
    allowed-methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
      - PATCH
    allowed-headers:
      - "*"
    allow-credentials: true
    max-age: 3600

# SpringDoc配置（Swagger UI）
springdoc:
  api-docs:
    enabled: true
    path: /api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    operations-sorter: method

# Actuator监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  # 关闭邮件健康检查避免本地无SMTP凭证导致健康探测失败
  health:
    mail:
      enabled: false
