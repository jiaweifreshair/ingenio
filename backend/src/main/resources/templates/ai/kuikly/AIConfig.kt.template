package {{PACKAGE_NAME}}.config

import java.io.File
import java.util.Properties

/**
 * AI配置管理
 * 管理AI服务相关的配置参数（API密钥、模型、参数等）
 *
 * 功能：
 * - 多来源配置读取（环境变量 > local.properties > 默认值）
 * - API密钥安全管理（脱敏显示）
 * - 配置验证和默认值
 * - 开发/生产环境适配
 *
 * 配置来源优先级：
 * 1. 环境变量（生产环境推荐）
 * 2. local.properties（开发环境）
 * 3. 默认值
 *
 * Generated by Ingenio Platform
 * Date: {{GENERATION_DATE}}
 */
object AIConfig {

    /**
     * 七牛云API密钥（必填）
     */
    val apiKey: String by lazy {
        getEnvOrProperty("QINIU_API_KEY")
            ?: throw IllegalStateException(
                """
                ⚠️ 七牛云API密钥未配置！

                请按以下步骤配置：

                【开发环境】
                1. 复制 local.properties.template 为 local.properties
                2. 填写: QINIU_API_KEY=your_api_key_here
                3. 重新运行应用

                【生产环境】
                1. 设置环境变量: export QINIU_API_KEY=your_api_key_here
                2. 或在启动脚本中配置

                【获取API密钥】
                1. 访问 https://www.qiniu.com
                2. 注册/登录账号
                3. 进入 "AI服务" -> "API密钥管理"
                4. 创建并复制API密钥
                """.trimIndent()
            )
    }

    /**
     * API基础URL
     */
    val baseUrl: String by lazy {
        getEnvOrProperty("AI_BASE_URL") ?: "https://api.qnaigc.com/v1"
    }

    /**
     * AI模型名称
     * 可选值：
     * - qwen-max（最强，推荐）
     * - qwen-turbo（平衡）
     * - qwen-plus（高性价比）
     */
    val model: String by lazy {
        getEnvOrProperty("AI_MODEL") ?: "qwen-max"
    }

    /**
     * 温度参数（0.0-2.0）
     * 控制AI响应的随机性和创造性
     * - 0.0：最确定，适合事实性回答
     * - 0.7：平衡（推荐）
     * - 2.0：最随机，适合创意内容
     */
    val temperature: Double by lazy {
        getEnvOrProperty("AI_TEMPERATURE")?.toDoubleOrNull() ?: 0.7
    }

    /**
     * 最大Token数
     * 限制AI响应的最大长度
     */
    val maxTokens: Int by lazy {
        getEnvOrProperty("AI_MAX_TOKENS")?.toIntOrNull() ?: 2000
    }

    /**
     * 请求超时时间（毫秒）
     */
    val timeout: Long by lazy {
        getEnvOrProperty("AI_TIMEOUT")?.toLongOrNull() ?: 60_000L
    }

    /**
     * 调试模式
     * 开启后会打印详细的请求和响应日志
     */
    val debug: Boolean by lazy {
        getEnvOrProperty("AI_DEBUG")?.toBooleanStrictOrNull() ?: false
    }

    /**
     * 从环境变量或配置文件读取配置
     *
     * 优先级：环境变量 > local.properties
     */
    private fun getEnvOrProperty(key: String): String? {
        // 1. 优先从环境变量读取（生产环境）
        System.getenv(key)?.let { return it }

        // 2. 从 local.properties 读取（开发环境）
        try {
            val localPropertiesFile = File("local.properties")
            if (localPropertiesFile.exists()) {
                val properties = Properties()
                localPropertiesFile.inputStream().use { properties.load(it) }
                properties.getProperty(key)?.let { return it }
            }
        } catch (e: Exception) {
            if (debug) {
                println("读取 local.properties 失败: ${e.message}")
            }
        }

        // 3. 从系统属性读取（可选）
        System.getProperty(key)?.let { return it }

        return null
    }

    /**
     * 验证配置完整性
     *
     * @throws IllegalStateException 如果必需配置缺失
     */
    fun validate() {
        // 触发延迟初始化，检查必需配置
        val _ = apiKey

        if (debug) {
            println("""
                AI配置加载成功：
                - API密钥: ${maskApiKey(apiKey)}
                - 基础URL: $baseUrl
                - 模型: $model
                - 温度: $temperature
                - 最大Token: $maxTokens
                - 超时: ${timeout}ms
                - 调试模式: $debug
            """.trimIndent())
        }
    }

    /**
     * 脱敏显示API密钥
     * 示例：sk-abc1234567890 -> sk-abc****890
     */
    fun maskApiKey(key: String): String {
        return if (key.length > 8) {
            "${key.take(6)}****${key.takeLast(4)}"
        } else {
            "****"
        }
    }

    /**
     * 重置配置（用于测试）
     */
    @Suppress("unused")
    fun reset() {
        // Kotlin lazy属性无法直接重置
        // 如需测试不同配置，请重启应用或使用模拟对象
    }
}

/**
 * 配置构建器（用于单元测试）
 */
class AIConfigBuilder {
    var apiKey: String? = null
    var baseUrl: String? = null
    var model: String? = null
    var temperature: Double? = null
    var maxTokens: Int? = null

    fun build(): Map<String, String> {
        val config = mutableMapOf<String, String>()
        apiKey?.let { config["QINIU_API_KEY"] = it }
        baseUrl?.let { config["AI_BASE_URL"] = it }
        model?.let { config["AI_MODEL"] = it }
        temperature?.let { config["AI_TEMPERATURE"] = it.toString() }
        maxTokens?.let { config["AI_MAX_TOKENS"] = it.toString() }
        return config
    }
}
