package {{PACKAGE_NAME}}.pages

import com.kuikly.core.Pager
import com.kuikly.core.ViewBuilder
import com.kuikly.core.annotations.Page
import com.kuikly.core.components.*
import com.kuikly.core.graphics.Color
import com.kuikly.core.modules.RouterModule
import {{PACKAGE_NAME}}.ai.AIService
import {{PACKAGE_NAME}}.config.AIConfig
import kotlinx.coroutines.launch
import org.json.JSONObject

/**
 * AI聊天服务页面
 *
 * 功能：
 * - 智能对话：支持与AI进行多轮对话
 * - 流式响应：实时显示AI回复内容
 * - 消息历史：保存和显示聊天记录
 * - 错误处理：友好的错误提示和重试机制
 *
 * 技术栈：
 * - KuiklyUI：声明式UI框架
 * - 七牛云AI：通义千问（Qwen-Max）模型
 * - Kotlin协程：异步处理AI请求
 *
 * Generated by Ingenio Platform
 * Date: {{GENERATION_DATE}}
 */
@Page("ai_chat")
internal class AIServicePager : Pager() {

    // AI服务实例
    private val aiService = AIService(AIConfig.apiKey)

    // 聊天消息列表
    private val messages = mutableListOf<ChatMessage>()

    // 当前流式响应文本
    private var streamingText = ""

    // 加载状态
    private var isLoading = false

    // 错误消息
    private var errorMessage: String? = null

    // 输入框文本
    private var inputText = ""

    override fun body(): ViewBuilder {
        return {
            attr {
                size(pagerData.pageViewWidth, pagerData.pageViewHeight)
                backgroundColor(Color.WHITE)
            }

            Column {
                attr {
                    size(pagerData.pageViewWidth, pagerData.pageViewHeight)
                }

                // 标题栏
                TitleBar()

                // 消息列表区域
                MessageList()

                // 错误提示（如果有）
                errorMessage?.let { error ->
                    ErrorBanner(error)
                }

                // 输入框
                InputBar()
            }
        }
    }

    /**
     * 标题栏
     */
    private fun TitleBar(): ViewBuilder = {
        View {
            attr {
                size(pagerData.pageViewWidth, 60f)
                backgroundColor(Color.parseColor("#6366F1"))
                padding(16f)
            }

            Row {
                attr {
                    size(pagerData.pageViewWidth - 32f, 28f)
                    centerVertical()
                }

                Text {
                    attr {
                        text("AI助手")
                        fontSize(20f)
                        color(Color.WHITE)
                        fontWeightBold()
                    }
                }
            }
        }
    }

    /**
     * 消息列表
     */
    private fun MessageList(): ViewBuilder = {
        ScrollView {
            attr {
                size(pagerData.pageViewWidth, pagerData.pageViewHeight - 180f)
                backgroundColor(Color.parseColor("#F9FAFB"))
            }

            Column {
                attr {
                    padding(16f)
                }

                // 显示历史消息
                messages.forEach { message ->
                    MessageBubble(message)
                }

                // 显示流式响应（实时更新）
                if (streamingText.isNotEmpty()) {
                    MessageBubble(
                        ChatMessage(role = "assistant", content = streamingText),
                        isStreaming = true
                    )
                }

                // 显示加载指示器
                if (isLoading && streamingText.isEmpty()) {
                    LoadingIndicator()
                }
            }
        }
    }

    /**
     * 消息气泡
     */
    private fun MessageBubble(message: ChatMessage, isStreaming: Boolean = false): ViewBuilder = {
        val isUser = message.role == "user"

        Row {
            attr {
                size(pagerData.pageViewWidth - 32f, autoHeight())
                if (isUser) alignEnd() else alignStart()
                marginBottom(12f)
            }

            View {
                attr {
                    widthIn(max = pagerData.pageViewWidth * 0.7f)
                    padding(12f)
                    cornerRadius(12f)
                    backgroundColor(
                        if (isUser) Color.parseColor("#6366F1")
                        else Color.parseColor("#E5E7EB")
                    )
                }

                Column {
                    Text {
                        attr {
                            text(message.content)
                            fontSize(16f)
                            color(
                                if (isUser) Color.WHITE
                                else Color.parseColor("#111827")
                            )
                            lineHeight(24f)
                        }
                    }

                    // 流式响应动画光标
                    if (isStreaming) {
                        Text {
                            attr {
                                text("▊")
                                fontSize(14f)
                                color(Color.parseColor("#6366F1"))
                                marginTop(4f)
                            }
                        }
                    }
                }
            }
        }
    }

    /**
     * 加载指示器
     */
    private fun LoadingIndicator(): ViewBuilder = {
        Row {
            attr {
                size(pagerData.pageViewWidth - 32f, 60f)
                alignStart()
            }

            View {
                attr {
                    size(120f, 44f)
                    cornerRadius(12f)
                    backgroundColor(Color.parseColor("#E5E7EB"))
                    padding(12f)
                }

                Row {
                    attr {
                        centerVertical()
                    }

                    // 简单的加载动画文本
                    Text {
                        attr {
                            text("AI正在思考...")
                            fontSize(14f)
                            color(Color.parseColor("#6B7280"))
                        }
                    }
                }
            }
        }
    }

    /**
     * 错误横幅
     */
    private fun ErrorBanner(message: String): ViewBuilder = {
        View {
            attr {
                size(pagerData.pageViewWidth, 60f)
                backgroundColor(Color.parseColor("#FEE2E2"))
                padding(16f)
            }

            Row {
                attr {
                    size(pagerData.pageViewWidth - 32f, 28f)
                    spaceBetween()
                    centerVertical()
                }

                Text {
                    attr {
                        text(message)
                        fontSize(14f)
                        color(Color.parseColor("#DC2626"))
                    }
                }

                Button {
                    attr {
                        titleAttr {
                            text("关闭")
                            fontSize(14f)
                            color(Color.parseColor("#DC2626"))
                        }
                        size(60f, 28f)
                        backgroundColor(Color.TRANSPARENT)
                    }

                    event {
                        onClick {
                            errorMessage = null
                            refresh()
                        }
                    }
                }
            }
        }
    }

    /**
     * 输入栏
     */
    private fun InputBar(): ViewBuilder = {
        View {
            attr {
                size(pagerData.pageViewWidth, 80f)
                backgroundColor(Color.WHITE)
                padding(16f)
            }

            Row {
                attr {
                    size(pagerData.pageViewWidth - 32f, 48f)
                    spaceBetween()
                    centerVertical()
                }

                // 输入框
                InputView {
                    attr {
                        placeholder("输入消息...")
                        size(pagerData.pageViewWidth - 112f, 48f)
                        fontSize(16f)
                        padding(12f)
                        cornerRadius(24f)
                        backgroundColor(Color.parseColor("#F3F4F6"))
                    }

                    event {
                        onTextChanged { text ->
                            inputText = text
                        }
                    }
                }

                // 发送按钮
                Button {
                    attr {
                        titleAttr {
                            text("发送")
                            fontSize(16f)
                            color(Color.WHITE)
                        }
                        size(64f, 48f)
                        cornerRadius(24f)
                        backgroundColor(Color.parseColor("#6366F1"))
                        enabled = !isLoading && inputText.isNotBlank()
                    }

                    event {
                        onClick {
                            sendMessage()
                        }
                    }
                }
            }
        }
    }

    /**
     * 发送消息（流式响应）
     */
    private fun sendMessage() {
        if (inputText.isBlank() || isLoading) return

        val userMessage = inputText.trim()
        inputText = ""

        // 添加用户消息到列表
        messages.add(ChatMessage(role = "user", content = userMessage))
        isLoading = true
        errorMessage = null
        streamingText = ""
        refresh()

        // 构建消息历史（保留最近10条）
        val history = messages.takeLast(10)

        // 调用AI服务（流式响应）
        pagerScope.launch {
            try {
                aiService.chatStream(history).collect { chunk ->
                    streamingText += chunk
                    refresh()
                }

                // 流式响应完成，添加到消息列表
                messages.add(ChatMessage(role = "assistant", content = streamingText))
                streamingText = ""
                isLoading = false
                refresh()

            } catch (e: Exception) {
                errorMessage = "AI请求失败: ${e.message ?: "未知错误"}"
                isLoading = false
                streamingText = ""
                refresh()
            }
        }
    }

    /**
     * 刷新页面
     */
    private fun refresh() {
        // KuiklyUI会自动重新渲染页面
        notifyDataSetChanged()
    }
}

/**
 * 聊天消息数据类
 */
data class ChatMessage(
    val role: String,  // "user" 或 "assistant"
    val content: String
)
