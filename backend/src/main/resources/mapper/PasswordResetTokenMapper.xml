<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ingenio.backend.mapper.PasswordResetTokenMapper">

    <!-- insertWithCast: UUID类型安全插入 -->
    <insert id="insertWithCast">
        INSERT INTO password_reset_tokens (
            user_id,
            token,
            expires_at,
            used,
            used_at,
            ip_address,
            user_agent
        ) VALUES (
            CAST(#{token.userId} AS UUID),
            #{token.token},
            #{token.expiresAt},
            #{token.used},
            #{token.usedAt},
            #{token.ipAddress},
            #{token.userAgent}
        )
    </insert>

    <!-- markAllAsUsedByUserIdWithCast: UUID类型安全更新 -->
    <update id="markAllAsUsedByUserIdWithCast">
        UPDATE password_reset_tokens
        SET used = TRUE
        WHERE user_id = CAST(#{userId} AS UUID) AND used = FALSE
    </update>

    <!-- updateByIdWithCast: UUID类型安全更新 -->
    <update id="updateByIdWithCast">
        UPDATE password_reset_tokens
        SET used = #{token.used},
            used_at = #{token.usedAt}
        WHERE id = CAST(#{token.id} AS UUID)
    </update>

</mapper>
