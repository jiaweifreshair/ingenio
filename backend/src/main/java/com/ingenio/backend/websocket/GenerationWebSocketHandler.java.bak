package com.ingenio.backend.websocket;

import cn.dev33.satoken.stp.StpUtil;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.ingenio.backend.entity.GenerationTaskEntity;
import com.ingenio.backend.service.AgentStatusService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;
import org.springframework.web.socket.*;

import java.io.IOException;
import java.net.URI;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.CopyOnWriteArraySet;

/**
 * WebSocket处理器 - 生成任务实时状态推送
 * 负责处理客户端WebSocket连接，推送Agent执行状态更新
 *
 * @author Ingenio Team
 * @since 1.0.0
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class GenerationWebSocketHandler implements WebSocketHandler {

    private final AgentStatusService agentStatusService;
    private final ObjectMapper objectMapper;

    /**
     * 活跃的WebSocket会话存储
     * Key: 任务ID, Value: WebSocket会话集合
     */
    private final Map<UUID, CopyOnWriteArraySet<WebSocketSession>> taskSessions = new ConcurrentHashMap<>();

    /**
     * 会话到任务ID的映射
     * Key: 会话ID, Value: 任务ID
     */
    private final Map<String, UUID> sessionTasks = new ConcurrentHashMap<>();

    @Override
    public void afterConnectionEstablished(WebSocketSession session) throws Exception {
        log.info("WebSocket连接建立: sessionId={}", session.getId());

        // 从查询参数中获取任务ID
        URI uri = session.getUri();
        if (uri != null) {
            String query = uri.getQuery();
            if (query != null && query.contains("taskId=")) {
                String taskIdStr = query.split("taskId=")[1].split("&")[0];
                try {
                    UUID taskId = UUID.fromString(taskIdStr);
                    registerTaskSession(taskId, session);
                } catch (IllegalArgumentException e) {
                    log.warn("无效的任务ID: {}, 关闭连接", taskIdStr);
                    session.close(CloseStatus.NOT_ACCEPTABLE.withReason("无效的任务ID"));
                }
            } else {
                log.warn("WebSocket连接缺少taskId参数，关闭连接");
                session.close(CloseStatus.NOT_ACCEPTABLE.withReason("缺少taskId参数"));
            }
        } else {
            log.warn("WebSocket连接URI为空，关闭连接");
            session.close(CloseStatus.NOT_ACCEPTABLE.withReason("URI为空"));
        }
    }

    @Override
    public void handleMessage(WebSocketSession session, WebSocketMessage<?> message) throws Exception {
        log.debug("收到WebSocket消息: sessionId={}, message={}", session.getId(), message.getPayload());

        try {
            String payload = message.getPayload().toString();
            @SuppressWarnings("unchecked")
            Map<String, Object> messageData = objectMapper.readValue(payload, Map.class);

            String type = (String) messageData.get("type");
            UUID taskId = sessionTasks.get(session.getId());

            if (taskId == null) {
                log.warn("会话未关联任务ID: sessionId={}", session.getId());
                sendErrorMessage(session, "会话未关联任务");
                return;
            }

            switch (type) {
                case "ping":
                    // 心跳检测
                    sendPongMessage(session);
                    break;

                case "subscribe":
                    // 订阅任务状态更新
                    log.info("客户端订阅任务状态: taskId={}, sessionId={}", taskId, session.getId());
                    sendTaskStatus(session, taskId);
                    break;

                case "cancel":
                    // 取消任务
                    log.info("客户端请求取消任务: taskId={}, sessionId={}", taskId, session.getId());
                    boolean cancelled = agentStatusService.cancelTask(taskId);
                    sendCancelResponse(session, cancelled);
                    break;

                default:
                    log.warn("未知消息类型: type={}, sessionId={}", type, session.getId());
                    sendErrorMessage(session, "未知消息类型: " + type);
            }
        } catch (Exception e) {
            log.error("处理WebSocket消息失败: sessionId={}", session.getId(), e);
            sendErrorMessage(session, "处理消息失败: " + e.getMessage());
        }
    }

    @Override
    public void handleTransportError(WebSocketSession session, Throwable exception) throws Exception {
        log.error("WebSocket传输错误: sessionId={}, error={}", session.getId(), exception.getMessage());
        unregisterSession(session);
    }

    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus closeStatus) throws Exception {
        log.info("WebSocket连接关闭: sessionId={}, status={}", session.getId(), closeStatus);
        unregisterSession(session);
    }

    @Override
    public boolean supportsPartialMessages() {
        return false;
    }

    /**
     * 注册任务会话
     *
     * @param taskId 任务ID
     * @param session WebSocket会话
     */
    private void registerTaskSession(UUID taskId, WebSocketSession session) {
        taskSessions.computeIfAbsent(taskId, k -> new CopyOnWriteArraySet<>()).add(session);
        sessionTasks.put(session.getId(), taskId);

        log.info("会话注册到任务: taskId={}, sessionId={}, 当前连接数={}",
                taskId, session.getId(), taskSessions.get(taskId).size());
    }

    /**
     * 注销会话
     *
     * @param session WebSocket会话
     */
    private void unregisterSession(WebSocketSession session) {
        UUID taskId = sessionTasks.remove(session.getId());
        if (taskId != null) {
            CopyOnWriteArraySet<WebSocketSession> sessions = taskSessions.get(taskId);
            if (sessions != null) {
                sessions.remove(session);
                if (sessions.isEmpty()) {
                    taskSessions.remove(taskId);
                }
            }

            log.info("会话从任务注销: taskId={}, sessionId={}, 剩余连接数={}",
                    taskId, session.getId(), taskSessions.getOrDefault(taskId, new CopyOnWriteArraySet<>()).size());
        }
    }

    /**
     * 广播任务状态更新
     *
     * @param taskId 任务ID
     * @param taskStatus 任务状态
     */
    @Async
    public void broadcastTaskStatus(UUID taskId, GenerationTaskEntity taskStatus) {
        CopyOnWriteArraySet<WebSocketSession> sessions = taskSessions.get(taskId);
        if (sessions == null || sessions.isEmpty()) {
            log.debug("任务{}没有活跃的WebSocket连接", taskId);
            return;
        }

        log.debug("广播任务状态: taskId={}, 连接数={}", taskId, sessions.size());

        for (WebSocketSession session : sessions) {
            if (session.isOpen()) {
                try {
                    sendTaskStatus(session, taskId, taskStatus);
                } catch (Exception e) {
                    log.error("发送任务状态失败: sessionId={}, taskId={}", session.getId(), taskId, e);
                }
            } else {
                log.debug("会话已关闭，移除: sessionId={}", session.getId());
                sessions.remove(session);
            }
        }
    }

    /**
     * 广播Agent状态更新
     *
     * @param taskId 任务ID
     * @param agentType Agent类型
     * @param status Agent状态
     * @param progress 进度
     * @param message 消息
     */
    @Async
    public void broadcastAgentStatus(UUID taskId, String agentType, String status,
                                   Integer progress, String message) {
        CopyOnWriteArraySet<WebSocketSession> sessions = taskSessions.get(taskId);
        if (sessions == null || sessions.isEmpty()) {
            log.debug("任务{}没有活跃的WebSocket连接", taskId);
            return;
        }

        for (WebSocketSession session : sessions) {
            if (session.isOpen()) {
                try {
                    sendAgentStatus(session, agentType, status, progress, message);
                } catch (Exception e) {
                    log.error("发送Agent状态失败: sessionId={}, taskId={}", session.getId(), taskId, e);
                }
            }
        }
    }

    /**
     * 发送任务状态
     *
     * @param session WebSocket会话
     * @param taskId 任务ID
     */
    private void sendTaskStatus(WebSocketSession session, UUID taskId) {
        try {
            GenerationTaskEntity taskStatus = agentStatusService.getTaskDetail(null, taskId); // TODO: 获取租户ID
            if (taskStatus != null) {
                sendTaskStatus(session, taskId, taskStatus);
            }
        } catch (Exception e) {
            log.error("获取任务状态失败: taskId={}", taskId, e);
            sendErrorMessage(session, "获取任务状态失败");
        }
    }

    /**
     * 发送任务状态
     *
     * @param session WebSocket会话
     * @param taskId 任务ID
     * @param taskStatus 任务状态
     */
    private void sendTaskStatus(WebSocketSession session, UUID taskId, GenerationTaskEntity taskStatus) {
        try {
            Map<String, Object> message = Map.of(
                "type", "taskStatus",
                "taskId", taskId.toString(),
                "status", taskStatus.getStatus(),
                "currentAgent", taskStatus.getCurrentAgent(),
                "progress", taskStatus.getProgress(),
                "timestamp", System.currentTimeMillis()
            );

            sendMessage(session, message);
        } catch (Exception e) {
            log.error("发送任务状态消息失败: sessionId={}, taskId={}", session.getId(), taskId, e);
        }
    }

    /**
     * 发送Agent状态
     *
     * @param session WebSocket会话
     * @param agentType Agent类型
     * @param status 状态
     * @param progress 进度
     * @param message 消息
     */
    private void sendAgentStatus(WebSocketSession session, String agentType, String status,
                                 Integer progress, String message) {
        try {
            Map<String, Object> agentInfo = Map.of(
                "agentType", agentType,
                "status", status,
                "progress", progress != null ? progress : 0,
                "message", message != null ? message : "",
                "timestamp", System.currentTimeMillis()
            );

            Map<String, Object> messageData = Map.of(
                "type", "agentStatus",
                "agentInfo", agentInfo
            );

            sendMessage(session, messageData);
        } catch (Exception e) {
            log.error("发送Agent状态消息失败: sessionId={}, agentType={}", session.getId(), agentType, e);
        }
    }

    /**
     * 发送心跳响应
     *
     * @param session WebSocket会话
     */
    private void sendPongMessage(WebSocketSession session) {
        try {
            Map<String, Object> message = Map.of(
                "type", "pong",
                "timestamp", System.currentTimeMillis()
            );

            sendMessage(session, message);
        } catch (Exception e) {
            log.error("发送pong消息失败: sessionId={}", session.getId(), e);
        }
    }

    /**
     * 发送取消任务响应
     *
     * @param session WebSocket会话
     * @param cancelled 是否取消成功
     */
    private void sendCancelResponse(WebSocketSession session, boolean cancelled) {
        try {
            Map<String, Object> message = Map.of(
                "type", "cancelResponse",
                "cancelled", cancelled,
                "timestamp", System.currentTimeMillis()
            );

            sendMessage(session, message);
        } catch (Exception e) {
            log.error("发送取消响应失败: sessionId={}", session.getId(), e);
        }
    }

    /**
     * 发送错误消息
     *
     * @param session WebSocket会话
     * @param errorMessage 错误消息
     */
    private void sendErrorMessage(WebSocketSession session, String errorMessage) {
        try {
            Map<String, Object> message = Map.of(
                "type", "error",
                "error", errorMessage,
                "timestamp", System.currentTimeMillis()
            );

            sendMessage(session, message);
        } catch (Exception e) {
            log.error("发送错误消息失败: sessionId={}", session.getId(), e);
        }
    }

    /**
     * 发送消息
     *
     * @param session WebSocket会话
     * @param message 消息内容
     */
    private void sendMessage(WebSocketSession session, Object message) {
        try {
            if (session.isOpen()) {
                String messageJson = objectMapper.writeValueAsString(message);
                session.sendMessage(new TextMessage(messageJson));
                log.debug("WebSocket消息发送成功: sessionId={}, message={}", session.getId(), messageJson);
            } else {
                log.debug("会话已关闭，无法发送消息: sessionId={}", session.getId());
            }
        } catch (IOException e) {
            log.error("WebSocket消息发送失败: sessionId={}", session.getId(), e);
        }
    }

    /**
     * 获取任务连接数
     *
     * @param taskId 任务ID
     * @return 连接数
     */
    public int getConnectionCount(UUID taskId) {
        CopyOnWriteArraySet<WebSocketSession> sessions = taskSessions.get(taskId);
        return sessions != null ? sessions.size() : 0;
    }

    /**
     * 获取总连接数
     *
     * @return 总连接数
     */
    public int getTotalConnectionCount() {
        return sessionTasks.size();
    }
}