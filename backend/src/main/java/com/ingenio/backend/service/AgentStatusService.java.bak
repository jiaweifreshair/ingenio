package com.ingenio.backend.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.IService;
import com.ingenio.backend.entity.GenerationTaskEntity;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.UUID;

/**
 * Agent状态管理服务接口
 * 负责管理AI生成任务的执行状态和Agent状态追踪
 */
public interface AgentStatusService extends IService<GenerationTaskEntity> {

    /**
     * 创建新的生成任务
     *
     * @param tenantId 租户ID
     * @param userId 用户ID
     * @param taskName 任务名称
     * @param userRequirement 用户需求
     * @return 创建的任务实体
     */
    GenerationTaskEntity createTask(UUID tenantId, UUID userId, String taskName, String userRequirement);

    /**
     * 开始执行任务
     *
     * @param taskId 任务ID
     * @param agentType Agent类型
     * @return 是否更新成功
     */
    boolean startTask(UUID taskId, GenerationTaskEntity.AgentType agentType);

    /**
     * 更新任务状态和进度
     *
     * @param taskId 任务ID
     * @param status 任务状态
     * @param currentAgent 当前Agent
     * @param progress 进度百分比（0-100）
     * @return 是否更新成功
     */
    boolean updateTaskStatus(UUID taskId, GenerationTaskEntity.Status status,
                           GenerationTaskEntity.AgentType currentAgent, Integer progress);

    /**
     * 更新Agent状态信息
     *
     * @param taskId 任务ID
     * @param agentType Agent类型
     * @param agentInfo Agent状态信息
     * @return 是否更新成功
     */
    boolean updateAgentInfo(UUID taskId, GenerationTaskEntity.AgentType agentType,
                           Map<String, Object> agentInfo);

    /**
     * 记录Agent执行结果
     *
     * @param taskId 任务ID
     * @param agentType Agent类型
     * @param result 执行结果
     * @return 是否更新成功
     */
    boolean recordAgentResult(UUID taskId, GenerationTaskEntity.AgentType agentType,
                             Map<String, Object> result);

    /**
     * 完成任务
     *
     * @param taskId 任务ID
     * @param appSpecId 生成的AppSpec ID
     * @param qualityScore 质量评分
     * @param downloadUrl 下载链接
     * @param previewUrl 预览链接
     * @param tokenUsage Token使用统计
     * @return 是否更新成功
     */
    boolean completeTask(UUID taskId, UUID appSpecId, Integer qualityScore,
                        String downloadUrl, String previewUrl, Map<String, Object> tokenUsage);

    /**
     * 标记任务失败
     *
     * @param taskId 任务ID
     * @param errorMessage 错误信息
     * @return 是否更新成功
     */
    boolean failTask(UUID taskId, String errorMessage);

    /**
     * 取消任务
     *
     * @param taskId 任务ID
     * @return 是否取消成功
     */
    boolean cancelTask(UUID taskId);

    /**
     * 获取任务状态
     *
     * @param taskId 任务ID
     * @return 任务状态
     */
    GenerationTaskEntity.Status getTaskStatus(UUID taskId);

    /**
     * 获取任务详细信息
     *
     * @param tenantId 租户ID
     * @param taskId 任务ID
     * @return 任务详细信息
     */
    GenerationTaskEntity getTaskDetail(UUID tenantId, UUID taskId);

    /**
     * 获取用户的任务列表（分页）
     *
     * @param tenantId 租户ID
     * @param userId 用户ID
     * @param pageNum 页码
     * @param pageSize 页大小
     * @return 任务分页列表
     */
    IPage<GenerationTaskEntity> getUserTasks(UUID tenantId, UUID userId, int pageNum, int pageSize);

    /**
     * 获取租户的任务列表（分页）
     *
     * @param tenantId 租户ID
     * @param pageNum 页码
     * @param pageSize 页大小
     * @return 任务分页列表
     */
    IPage<GenerationTaskEntity> getTenantTasks(UUID tenantId, int pageNum, int pageSize);

    /**
     * 根据状态查询任务列表
     *
     * @param tenantId 租户ID
     * @param status 任务状态
     * @return 任务列表
     */
    List<GenerationTaskEntity> getTasksByStatus(UUID tenantId, GenerationTaskEntity.Status status);

    /**
     * 获取正在运行的任务
     *
     * @param tenantId 租户ID
     * @return 运行中的任务列表
     */
    List<GenerationTaskEntity> getRunningTasks(UUID tenantId);

    /**
     * 统计用户任务状态
     *
     * @param tenantId 租户ID
     * @param userId 用户ID
     * @return 状态统计结果
     */
    Map<String, Object> getUserTaskStatistics(UUID tenantId, UUID userId);

    /**
     * 检查用户是否可以创建新任务
     *
     * @param tenantId 租户ID
     * @param userId 用户ID
     * @param maxConcurrentTasks 最大并发任务数
     * @return 是否可以创建新任务
     */
    boolean canCreateNewTask(UUID tenantId, UUID userId, int maxConcurrentTasks);

    /**
     * 清理过期任务
     *
     * @param tenantId 租户ID
     * @param beforeDays 保留天数
     * @return 清理的任务数量
     */
    int cleanupExpiredTasks(UUID tenantId, int beforeDays);

    /**
     * 获取任务执行时长统计
     *
     * @param tenantId 租户ID
     * @param startTime 开始时间
     * @param endTime 结束时间
     * @return 执行时长统计
     */
    Map<String, Object> getTaskDurationStatistics(UUID tenantId, LocalDateTime startTime,
                                                LocalDateTime endTime);
}