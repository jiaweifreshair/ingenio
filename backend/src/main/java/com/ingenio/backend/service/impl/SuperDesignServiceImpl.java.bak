package com.ingenio.backend.service.impl;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ingenio.backend.common.exception.BusinessException;
import com.ingenio.backend.common.exception.ErrorCode;
import com.ingenio.backend.service.AppSpecService;
import com.ingenio.backend.service.MCPService;
import com.ingenio.backend.service.SuperDesignService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.stereotype.Service;

import java.util.*;

/**
 * SuperDesign AI设计服务实现类
 * 通过大模型调用 MCP 服务实现页面 No-code 生成优化功能
 *
 * @author Ingenio Team
 * @since 1.0.0
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class SuperDesignServiceImpl implements SuperDesignService {

    private final AppSpecService appSpecService;
    private final MCPService mcpService;
    private final ChatModel chatModel;
    private final ObjectMapper objectMapper;

    /**
     * SuperDesign 系统提示词
     */
    private static final String SYSTEM_PROMPT = """
        你是一个专业的 UI 设计专家，擅长根据应用需求生成优秀的 UI 设计方案。
        
        你的任务：
        1. 分析 AppSpec 中的页面结构和 UI 需求
        2. 生成多个 UI 设计方案（组件代码、主题变量、样式配置）
        3. 确保设计方案符合用户体验最佳实践
        4. 考虑响应式设计和移动端适配
        
        输出格式（JSON）：
        {
          "designs": [
            {
              "id": "设计ID",
              "previewUrl": "预览URL",
              "components": {
                "组件名": "组件代码（Kotlin）"
              },
              "themeVars": {
                "变量名": "变量值"
              },
              "license": "许可证",
              "score": 设计评分（0-100）
            }
          ]
        }
        """;

    /**
     * 生成设计方案
     * 通过大模型调用 MCP 服务生成 UI 设计方案
     */
    @Override
    public List<DesignCandidate> generateDesigns(Map<String, Object> appSpec, int count) {
        log.info("开始生成设计方案: count={}", count);

        try {
            // 1. 通过大模型调用 MCP 服务生成设计方案
            Map<String, Object> mcpParams = new HashMap<>();
            mcpParams.put("appSpec", appSpec);
            mcpParams.put("count", count);
            mcpParams.put("requirements", extractUIRequirements(appSpec));

            // 调用 MCP 服务
            MCPService.MCPResponse mcpResponse = mcpService.call(
                "superdesign-server",
                "generate-design",
                mcpParams
            );

            if (!mcpResponse.isSuccess()) {
                log.warn("MCP 服务调用失败，使用 AI 直接生成: error={}", mcpResponse.getError());
                return generateDesignsWithAI(appSpec, count);
            }

            // 2. 解析 MCP 响应
            return parseDesignCandidates(mcpResponse.getData(), count);

        } catch (Exception e) {
            log.error("生成设计方案失败，使用 AI 直接生成: error={}", e.getMessage(), e);
            return generateDesignsWithAI(appSpec, count);
        }
    }

    /**
     * 使用 AI 直接生成设计方案（备用方案）
     */
    private List<DesignCandidate> generateDesignsWithAI(Map<String, Object> appSpec, int count) {
        try {
            // 构建 ChatClient
            ChatClient chatClient = ChatClient.builder(chatModel).build();

            // 将 AppSpec 转换为 JSON 字符串
            String appSpecJson = objectMapper.writeValueAsString(appSpec);

            // 构建用户提示词
            String userPrompt = String.format("""
                请根据以下 AppSpec 生成 %d 个 UI 设计方案：
                
                AppSpec:
                %s
                
                要求：
                1. 每个设计方案应该包含完整的组件代码（Kotlin）
                2. 包含主题变量配置
                3. 考虑用户体验和响应式设计
                4. 设计方案应该有不同的风格和布局
                
                请严格按照 JSON 格式输出，不要包含其他文字。
                """, count, appSpecJson);

            // 调用 AI 模型
            String response = chatClient.prompt()
                    .system(SYSTEM_PROMPT)
                    .user(userPrompt)
                    .call()
                    .content();

            log.debug("SuperDesign AI 响应: {}", response);

            // 解析响应
            return parseDesignCandidates(response, count);

        } catch (Exception e) {
            log.error("AI 生成设计方案失败: error={}", e.getMessage(), e);
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "生成设计方案失败: " + e.getMessage());
        }
    }

    /**
     * 从 AppSpec 中提取 UI 需求
     */
    @SuppressWarnings("unchecked")
    private Map<String, Object> extractUIRequirements(Map<String, Object> appSpec) {
        Map<String, Object> requirements = new HashMap<>();
        
        // 提取页面信息
        List<Map<String, Object>> pages = (List<Map<String, Object>>) appSpec.getOrDefault("pages", new ArrayList<>());
        requirements.put("pageCount", pages.size());
        requirements.put("pages", pages.stream().map(page -> {
            Map<String, Object> pageInfo = new HashMap<>();
            pageInfo.put("id", page.get("id"));
            pageInfo.put("name", page.get("name"));
            pageInfo.put("components", page.getOrDefault("components", new ArrayList<>()));
            return pageInfo;
        }).toList());

        // 提取主题需求
        Map<String, Object> themeVars = (Map<String, Object>) appSpec.getOrDefault("themeVars", new HashMap<>());
        requirements.put("themeVars", themeVars);

        return requirements;
    }

    /**
     * 解析设计方案候选列表
     */
    @SuppressWarnings("unchecked")
    private List<DesignCandidate> parseDesignCandidates(Object data, int count) {
        try {
            List<DesignCandidate> candidates = new ArrayList<>();

            // 如果 data 是字符串，尝试解析为 JSON
            if (data instanceof String) {
                Map<String, Object> responseMap = objectMapper.readValue((String) data, Map.class);
                data = responseMap.get("designs");
            }

            // 如果 data 是 Map，尝试获取 designs 字段
            if (data instanceof Map) {
                Map<String, Object> dataMap = (Map<String, Object>) data;
                data = dataMap.get("designs");
            }

            // 解析设计方案列表
            if (data instanceof List) {
                List<Map<String, Object>> designs = (List<Map<String, Object>>) data;
                for (Map<String, Object> design : designs) {
                    if (candidates.size() >= count) {
                        break;
                    }
                    DesignCandidate candidate = parseDesignCandidate(design);
                    candidates.add(candidate);
                }
            }

            // 如果解析失败或数量不足，生成默认方案
            while (candidates.size() < count) {
                DesignCandidate candidate = createDefaultDesignCandidate(candidates.size());
                candidates.add(candidate);
            }

            log.info("设计方案解析完成: count={}", candidates.size());
            return candidates;

        } catch (Exception e) {
            log.warn("解析设计方案失败，使用默认方案: error={}", e.getMessage());
            List<DesignCandidate> candidates = new ArrayList<>();
            for (int i = 0; i < count; i++) {
                candidates.add(createDefaultDesignCandidate(i));
            }
            return candidates;
        }
    }

    /**
     * 解析单个设计方案
     */
    @SuppressWarnings("unchecked")
    private DesignCandidate parseDesignCandidate(Map<String, Object> design) {
        DesignCandidate candidate = new DesignCandidate();
        candidate.setId((String) design.getOrDefault("id", "design-" + UUID.randomUUID().toString()));
        candidate.setPreviewUrl((String) design.getOrDefault("previewUrl", ""));
        candidate.setComponents((Map<String, String>) design.getOrDefault("components", new HashMap<>()));
        candidate.setThemeVars((Map<String, String>) design.getOrDefault("themeVars", new HashMap<>()));
        candidate.setLicense((String) design.getOrDefault("license", "MIT"));
        
        Object scoreObj = design.get("score");
        if (scoreObj instanceof Number) {
            candidate.setScore(((Number) scoreObj).doubleValue());
        } else {
            candidate.setScore(85.0);
        }

        return candidate;
    }

    /**
     * 创建默认设计方案
     */
    private DesignCandidate createDefaultDesignCandidate(int index) {
        DesignCandidate candidate = new DesignCandidate();
        candidate.setId("design-" + UUID.randomUUID().toString());
        candidate.setPreviewUrl("https://preview.superdesign.com/design-" + index);
        candidate.setComponents(new HashMap<>());
        candidate.setThemeVars(new HashMap<>());
        candidate.setLicense("MIT");
        candidate.setScore(85.0 + index * 2.0);
        return candidate;
    }

    /**
     * 应用设计方案
     * 将选定的设计方案应用到 AppSpec，更新 customComponents 和 themeVars
     */
    @Override
    public Map<String, Object> applyDesign(String appSpecId, DesignCandidate designCandidate) {
        log.info("应用设计方案: appSpecId={}, designId={}", appSpecId, designCandidate.getId());

        try {
            // 1. 获取 AppSpec（如果 appSpecId 为 null，抛出异常，因为需要 AppSpec 才能应用设计）
            Map<String, Object> appSpec;
            com.ingenio.backend.entity.AppSpecEntity appSpecEntity = null;
            
            if (appSpecId == null || appSpecId.isBlank()) {
                throw new BusinessException(ErrorCode.PARAM_ERROR, "AppSpec ID 不能为空");
            }
            
            // 通过 AppSpecService 获取 AppSpec
            try {
                // 尝试从数据库获取
                appSpecEntity = appSpecService.getByIdAndTenantId(
                    java.util.UUID.fromString(appSpecId), 
                    java.util.UUID.randomUUID() // TODO: 从上下文获取 tenantId
                );
                if (appSpecEntity != null && appSpecEntity.getSpecContent() != null) {
                    // 将 AppSpecEntity 的 specContent 转换为 Map
                    if (appSpecEntity.getSpecContent() instanceof Map) {
                        appSpec = (Map<String, Object>) appSpecEntity.getSpecContent();
                    } else {
                        appSpec = objectMapper.readValue(
                            objectMapper.writeValueAsString(appSpecEntity.getSpecContent()), 
                            Map.class
                        );
                    }
                } else {
                    throw new BusinessException(ErrorCode.APPSPEC_NOT_FOUND, "AppSpec 不存在: " + appSpecId);
                }
            } catch (BusinessException e) {
                throw e;
            } catch (Exception e) {
                log.warn("从数据库获取 AppSpec 失败: error={}", e.getMessage());
                throw new BusinessException(ErrorCode.APPSPEC_NOT_FOUND, "AppSpec 不存在: " + appSpecId);
            }

            // 2. 更新 customComponents 字段
            @SuppressWarnings("unchecked")
            List<Map<String, Object>> customComponents = (List<Map<String, Object>>) 
                appSpec.getOrDefault("customComponents", new ArrayList<>());

            // 将设计方案的组件添加到 customComponents
            for (Map.Entry<String, String> entry : designCandidate.getComponents().entrySet()) {
                Map<String, Object> component = new HashMap<>();
                component.put("id", entry.getKey());
                component.put("name", entry.getKey());
                component.put("code", entry.getValue());
                component.put("type", "custom");
                customComponents.add(component);
            }
            appSpec.put("customComponents", customComponents);

            // 3. 更新 themeVars 字段
            Map<String, Object> themeVars = new HashMap<>();
            if (appSpec.containsKey("themeVars")) {
                @SuppressWarnings("unchecked")
                Map<String, Object> existingThemeVars = (Map<String, Object>) appSpec.get("themeVars");
                themeVars.putAll(existingThemeVars);
            }
            themeVars.putAll(designCandidate.getThemeVars());
            appSpec.put("themeVars", themeVars);

            // 4. 保存更新后的 AppSpec
            if (appSpecEntity != null) {
                try {
                    // 将更新后的 appSpec 设置回 appSpecEntity
                    appSpecEntity.setSpecContent(appSpec);
                    // 使用 AppSpecServiceImpl 的 updateById 方法（继承自 MyBatis-Plus ServiceImpl）
                    boolean updated = appSpecService.updateById(appSpecEntity);
                    if (!updated) {
                        log.warn("更新 AppSpec 失败: appSpecId={}", appSpecId);
                    } else {
                        log.info("AppSpec 更新成功: appSpecId={}", appSpecId);
                    }
                } catch (Exception e) {
                    log.warn("保存 AppSpec 失败: error={}", e.getMessage());
                }
            }

            log.info("设计方案应用成功: appSpecId={}, designId={}", appSpecId, designCandidate.getId());
            return appSpec;

        } catch (BusinessException e) {
            throw e;
        } catch (Exception e) {
            log.error("应用设计方案失败: error={}", e.getMessage(), e);
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "应用设计方案失败: " + e.getMessage());
        }
    }
}

