package com.ingenio.backend.service.impl;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ingenio.backend.common.exception.BusinessException;
import com.ingenio.backend.common.exception.ErrorCode;
import com.ingenio.backend.service.AipexBaseService;
import com.ingenio.backend.service.MCPService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.stereotype.Service;

import java.util.*;

/**
 * AipexBase 服务端 No-code 生成服务实现类
 * 通过大模型调用 MCP 服务实现数据/鉴权/文件三链路托管功能
 *
 * @author Ingenio Team
 * @since 1.0.0
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class AipexBaseServiceImpl implements AipexBaseService {

    private final MCPService mcpService;
    private final ChatModel chatModel;
    private final ObjectMapper objectMapper;

    /**
     * AipexBase 系统提示词
     */
    private static final String SYSTEM_PROMPT = """
        你是一个专业的后端架构专家，擅长根据应用需求确定后端代码资源和实现方案。
        
        你的任务：
        1. 分析 AppSpec 中的数据模型、权限和流程需求
        2. 确定所需的后端资源（数据表、API、认证、存储等）
        3. 生成 AipexBase 配置（表配置、认证配置、存储配置）
        4. 生成 API 调用代码
        
        输出格式（JSON）：
        {
          "projectId": "项目ID",
          "endpoint": "API端点",
          "tables": [
            {
              "tableName": "表名",
              "dataModelId": "数据模型ID",
              "autoSync": true,
              "permissions": {
                "read": ["角色列表"],
                "write": ["角色列表"],
                "delete": ["角色列表"]
              }
            }
          ],
          "auth": {
            "providers": ["wechat", "email", "phone"],
            "sessionTimeout": 3600
          },
          "storage": {
            "bucket": "存储桶名",
            "maxFileSize": 10485760,
            "allowedTypes": ["image/*", "document/*"]
          },
          "apiCode": "生成的 API 调用代码"
        }
        """;

    /**
     * 生成 AipexBase 配置
     * 通过大模型调用 MCP 服务确定后端代码资源和实现
     */
    @Override
    public AipexBaseConfig generateConfig(Map<String, Object> appSpec) {
        log.info("开始生成 AipexBase 配置");

        try {
            // 1. 通过大模型调用 MCP 服务确定后端资源
            Map<String, Object> mcpParams = new HashMap<>();
            mcpParams.put("appSpec", appSpec);
            mcpParams.put("requirements", extractBackendRequirements(appSpec));

            // 调用 MCP 服务
            MCPService.MCPResponse mcpResponse = mcpService.call(
                "aipexbase-server",
                "determine-resources",
                mcpParams
            );

            if (!mcpResponse.isSuccess()) {
                log.warn("MCP 服务调用失败，使用 AI 直接生成: error={}", mcpResponse.getError());
                return generateConfigWithAI(appSpec);
            }

            // 2. 解析 MCP 响应并生成配置
            return parseAipexBaseConfig(mcpResponse.getData(), appSpec);

        } catch (Exception e) {
            log.error("生成 AipexBase 配置失败，使用 AI 直接生成: error={}", e.getMessage(), e);
            return generateConfigWithAI(appSpec);
        }
    }

    /**
     * 使用 AI 直接生成配置（备用方案）
     */
    private AipexBaseConfig generateConfigWithAI(Map<String, Object> appSpec) {
        try {
            // 构建 ChatClient
            ChatClient chatClient = ChatClient.builder(chatModel).build();

            // 将 AppSpec 转换为 JSON 字符串
            String appSpecJson = objectMapper.writeValueAsString(appSpec);

            // 构建用户提示词
            String userPrompt = String.format("""
                请根据以下 AppSpec 确定后端代码资源和实现方案：
                
                AppSpec:
                %s
                
                要求：
                1. 分析数据模型，生成数据表配置
                2. 分析权限需求，生成认证配置
                3. 分析流程需求，生成存储配置
                4. 生成完整的 API 调用代码（Kotlin）
                
                请严格按照 JSON 格式输出，不要包含其他文字。
                """, appSpecJson);

            // 调用 AI 模型
            String response = chatClient.prompt()
                    .system(SYSTEM_PROMPT)
                    .user(userPrompt)
                    .call()
                    .content();

            log.debug("AipexBase AI 响应: {}", response);

            // 解析响应
            return parseAipexBaseConfig(response, appSpec);

        } catch (Exception e) {
            log.error("AI 生成 AipexBase 配置失败: error={}", e.getMessage(), e);
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "生成 AipexBase 配置失败: " + e.getMessage());
        }
    }

    /**
     * 从 AppSpec 中提取后端需求
     */
    @SuppressWarnings("unchecked")
    private Map<String, Object> extractBackendRequirements(Map<String, Object> appSpec) {
        Map<String, Object> requirements = new HashMap<>();
        
        // 提取数据模型
        List<Map<String, Object>> dataModels = (List<Map<String, Object>>) 
            appSpec.getOrDefault("dataModels", new ArrayList<>());
        requirements.put("dataModelCount", dataModels.size());
        requirements.put("dataModels", dataModels);

        // 提取权限需求
        List<Map<String, Object>> permissions = (List<Map<String, Object>>) 
            appSpec.getOrDefault("permissions", new ArrayList<>());
        requirements.put("permissions", permissions);

        // 提取流程需求
        List<Map<String, Object>> flows = (List<Map<String, Object>>) 
            appSpec.getOrDefault("flows", new ArrayList<>());
        requirements.put("flows", flows);

        // 检查是否需要文件存储
        boolean needsStorage = flows.stream()
            .anyMatch(flow -> {
                List<Map<String, Object>> actions = (List<Map<String, Object>>) 
                    flow.getOrDefault("actions", new ArrayList<>());
                return actions.stream()
                    .anyMatch(action -> "upload".equals(action.get("type")) || 
                                      "file".equals(action.get("type")));
            });
        requirements.put("needsStorage", needsStorage);

        return requirements;
    }

    /**
     * 解析 AipexBase 配置
     */
    @SuppressWarnings("unchecked")
    private AipexBaseConfig parseAipexBaseConfig(Object data, Map<String, Object> appSpec) {
        try {
            AipexBaseConfig config = new AipexBaseConfig();

            // 如果 data 是字符串，尝试解析为 JSON
            Map<String, Object> configMap;
            if (data instanceof String) {
                configMap = objectMapper.readValue((String) data, Map.class);
            } else if (data instanceof Map) {
                configMap = (Map<String, Object>) data;
            } else {
                throw new IllegalArgumentException("无效的配置数据格式");
            }

            // 解析配置
            config.setProjectId((String) configMap.getOrDefault("projectId", UUID.randomUUID().toString()));
            config.setEndpoint((String) configMap.getOrDefault("endpoint", "https://api.aipexbase.com"));
            config.setApiKey((String) configMap.getOrDefault("apiKey", ""));

            // 解析表配置
            List<TableConfig> tables = new ArrayList<>();
            if (configMap.containsKey("tables")) {
                List<Map<String, Object>> tablesData = (List<Map<String, Object>>) configMap.get("tables");
                for (Map<String, Object> tableData : tablesData) {
                    TableConfig table = parseTableConfig(tableData);
                    tables.add(table);
                }
            } else {
                // 如果没有表配置，从 AppSpec 生成
                tables = generateTablesFromAppSpec(appSpec);
            }
            config.setTables(tables);

            // 解析认证配置
            AuthConfig auth = new AuthConfig();
            if (configMap.containsKey("auth")) {
                Map<String, Object> authData = (Map<String, Object>) configMap.get("auth");
                auth.setProviders((List<String>) authData.getOrDefault("providers", List.of("email")));
                Object timeout = authData.get("sessionTimeout");
                if (timeout instanceof Number) {
                    auth.setSessionTimeout(((Number) timeout).intValue());
                } else {
                    auth.setSessionTimeout(3600);
                }
            } else {
                auth.setProviders(List.of("email"));
                auth.setSessionTimeout(3600);
            }
            config.setAuth(auth);

            // 解析存储配置
            StorageConfig storage = new StorageConfig();
            if (configMap.containsKey("storage")) {
                Map<String, Object> storageData = (Map<String, Object>) configMap.get("storage");
                storage.setBucket((String) storageData.getOrDefault("bucket", "default-bucket"));
                Object maxSize = storageData.get("maxFileSize");
                if (maxSize instanceof Number) {
                    storage.setMaxFileSize(((Number) maxSize).longValue());
                } else {
                    storage.setMaxFileSize(10485760L); // 10MB
                }
                storage.setAllowedTypes((List<String>) storageData.getOrDefault("allowedTypes", 
                    List.of("image/*", "document/*")));
            } else {
                storage.setBucket("default-bucket");
                storage.setMaxFileSize(10485760L);
                storage.setAllowedTypes(List.of("image/*", "document/*"));
            }
            config.setStorage(storage);

            // 解析 API 代码
            String apiCode = (String) configMap.getOrDefault("apiCode", generateDefaultApiCode(tables));
            config.setApiCode(apiCode);

            log.info("AipexBase 配置解析完成: projectId={}, tables={}", 
                config.getProjectId(), config.getTables().size());
            return config;

        } catch (Exception e) {
            log.warn("解析 AipexBase 配置失败，使用默认配置: error={}", e.getMessage());
            return createDefaultConfig(appSpec);
        }
    }

    /**
     * 从 AppSpec 生成表配置
     */
    @SuppressWarnings("unchecked")
    private List<TableConfig> generateTablesFromAppSpec(Map<String, Object> appSpec) {
        List<TableConfig> tables = new ArrayList<>();
        List<Map<String, Object>> dataModels = (List<Map<String, Object>>) 
            appSpec.getOrDefault("dataModels", new ArrayList<>());

        for (Map<String, Object> dataModel : dataModels) {
            TableConfig table = new TableConfig();
            table.setTableName((String) dataModel.getOrDefault("name", "table_" + dataModel.get("id")));
            table.setDataModelId((String) dataModel.get("id"));
            table.setAutoSync(true);

            // 设置权限
            Permissions permissions = new Permissions();
            permissions.setRead(List.of("user", "admin"));
            permissions.setWrite(List.of("admin"));
            permissions.setDelete(List.of("admin"));
            table.setPermissions(permissions);

            tables.add(table);
        }

        return tables;
    }

    /**
     * 解析表配置
     */
    @SuppressWarnings("unchecked")
    private TableConfig parseTableConfig(Map<String, Object> tableData) {
        TableConfig table = new TableConfig();
        table.setTableName((String) tableData.get("tableName"));
        table.setDataModelId((String) tableData.get("dataModelId"));
        table.setAutoSync(Boolean.TRUE.equals(tableData.getOrDefault("autoSync", true)));

        if (tableData.containsKey("permissions")) {
            Map<String, Object> permsData = (Map<String, Object>) tableData.get("permissions");
            Permissions permissions = new Permissions();
            permissions.setRead((List<String>) permsData.getOrDefault("read", new ArrayList<>()));
            permissions.setWrite((List<String>) permsData.getOrDefault("write", new ArrayList<>()));
            permissions.setDelete((List<String>) permsData.getOrDefault("delete", new ArrayList<>()));
            table.setPermissions(permissions);
        } else {
            Permissions permissions = new Permissions();
            permissions.setRead(List.of("user", "admin"));
            permissions.setWrite(List.of("admin"));
            permissions.setDelete(List.of("admin"));
            table.setPermissions(permissions);
        }

        return table;
    }

    /**
     * 生成默认 API 代码
     */
    private String generateDefaultApiCode(List<TableConfig> tables) {
        StringBuilder code = new StringBuilder();
        code.append("// AipexBase API 调用代码\n");
        code.append("import com.aipexbase.sdk.AipexBaseClient\n\n");
        code.append("class AipexBaseService {\n");
        code.append("    private val client = AipexBaseClient(\"YOUR_API_KEY\")\n\n");

        for (TableConfig table : tables) {
            String tableName = table.getTableName();
            String modelName = capitalize(tableName);
            code.append(String.format("    // %s 相关操作\n", modelName));
            code.append(String.format("    suspend fun create%s(data: Map<String, Any>): Result<Map<String, Any>> {\n", modelName));
            code.append(String.format("        return client.table(\"%s\").create(data)\n", tableName));
            code.append("    }\n\n");
            code.append(String.format("    suspend fun get%s(id: String): Result<Map<String, Any>> {\n", modelName));
            code.append(String.format("        return client.table(\"%s\").get(id)\n", tableName));
            code.append("    }\n\n");
        }

        code.append("}\n");
        return code.toString();
    }

    /**
     * 首字母大写
     */
    private String capitalize(String str) {
        if (str == null || str.isEmpty()) {
            return str;
        }
        return str.substring(0, 1).toUpperCase() + str.substring(1);
    }

    /**
     * 创建默认配置
     */
    @SuppressWarnings("unchecked")
    private AipexBaseConfig createDefaultConfig(Map<String, Object> appSpec) {
        AipexBaseConfig config = new AipexBaseConfig();
        config.setProjectId(UUID.randomUUID().toString());
        config.setEndpoint("https://api.aipexbase.com");
        config.setApiKey("");

        // 从 AppSpec 生成表配置
        config.setTables(generateTablesFromAppSpec(appSpec));

        // 默认认证配置
        AuthConfig auth = new AuthConfig();
        auth.setProviders(List.of("email"));
        auth.setSessionTimeout(3600);
        config.setAuth(auth);

        // 默认存储配置
        StorageConfig storage = new StorageConfig();
        storage.setBucket("default-bucket");
        storage.setMaxFileSize(10485760L);
        storage.setAllowedTypes(List.of("image/*", "document/*"));
        config.setStorage(storage);

        // 生成默认 API 代码
        config.setApiCode(generateDefaultApiCode(config.getTables()));

        return config;
    }

    /**
     * 部署到 AipexBase
     * 通过大模型调用 MCP 服务部署配置
     */
    @Override
    public DeploymentResult deploy(AipexBaseConfig config) {
        log.info("开始部署到 AipexBase: projectId={}", config.getProjectId());

        try {
            // 1. 通过大模型调用 MCP 服务部署配置
            Map<String, Object> mcpParams = new HashMap<>();
            mcpParams.put("config", config);

            // 调用 MCP 服务
            MCPService.MCPResponse mcpResponse = mcpService.call(
                "aipexbase-server",
                "deploy-config",
                mcpParams
            );

            if (!mcpResponse.isSuccess()) {
                log.warn("MCP 服务调用失败，使用模拟部署: error={}", mcpResponse.getError());
                return createMockDeploymentResult(config);
            }

            // 2. 解析部署结果
            return parseDeploymentResult(mcpResponse.getData(), config);

        } catch (Exception e) {
            log.error("部署到 AipexBase 失败: error={}", e.getMessage(), e);
            return createMockDeploymentResult(config);
        }
    }

    /**
     * 解析部署结果
     */
    @SuppressWarnings("unchecked")
    private DeploymentResult parseDeploymentResult(Object data, AipexBaseConfig config) {
        try {
            DeploymentResult result = new DeploymentResult();

            // 如果 data 是字符串，尝试解析为 JSON
            Map<String, Object> resultMap;
            if (data instanceof String) {
                resultMap = objectMapper.readValue((String) data, Map.class);
            } else if (data instanceof Map) {
                resultMap = (Map<String, Object>) data;
            } else {
                return createMockDeploymentResult(config);
            }

            result.setSuccess(Boolean.TRUE.equals(resultMap.getOrDefault("success", true)));
            result.setDeploymentId((String) resultMap.getOrDefault("deploymentId", UUID.randomUUID().toString()));
            result.setMessage((String) resultMap.getOrDefault("message", "部署成功"));
            result.setEndpoints((Map<String, String>) resultMap.getOrDefault("endpoints", new HashMap<>()));

            return result;

        } catch (Exception e) {
            log.warn("解析部署结果失败，使用模拟结果: error={}", e.getMessage());
            return createMockDeploymentResult(config);
        }
    }

    /**
     * 创建模拟部署结果（用于测试）
     */
    private DeploymentResult createMockDeploymentResult(AipexBaseConfig config) {
        DeploymentResult result = new DeploymentResult();
        result.setSuccess(true);
        result.setDeploymentId(UUID.randomUUID().toString());
        result.setMessage("部署成功（模拟）");

        // 生成 API 端点映射
        Map<String, String> endpoints = new HashMap<>();
        endpoints.put("baseUrl", config.getEndpoint());
        for (TableConfig table : config.getTables()) {
            String tableName = table.getTableName();
            endpoints.put(tableName + "_create", config.getEndpoint() + "/api/tables/" + tableName + "/create");
            endpoints.put(tableName + "_get", config.getEndpoint() + "/api/tables/" + tableName + "/get");
            endpoints.put(tableName + "_update", config.getEndpoint() + "/api/tables/" + tableName + "/update");
            endpoints.put(tableName + "_delete", config.getEndpoint() + "/api/tables/" + tableName + "/delete");
        }
        result.setEndpoints(endpoints);

        return result;
    }
}

