package com.ingenio.backend.controller;

import com.ingenio.backend.common.exception.ErrorCode;
import com.ingenio.backend.common.response.Result;
import com.ingenio.backend.service.AINativeService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * AI Native 产品支持Controller
 * 提供 Agent 组件/MCP 调用功能
 *
 * @author Ingenio Team
 * @since 1.0.0
 */
@Slf4j
@RestController
@RequestMapping("/api/v1/ai")
@RequiredArgsConstructor
public class AINativeController {

    private final AINativeService aiNativeService;

    /**
     * 生成 AI 功能代码
     * 根据 AI 功能规范生成前端组件和后端 API 代码
     *
     * @param request 包含 aiFeatures 的请求
     * @return 生成的代码
     */
    @PostMapping("/generate-code")
    public Result<AINativeService.AICodeResult> generateAICode(
            @Valid @RequestBody Map<String, Object> request) {
        @SuppressWarnings("unchecked")
        List<Map<String, Object>> aiFeaturesData = (List<Map<String, Object>>) request.get("aiFeatures");

        if (aiFeaturesData == null || aiFeaturesData.isEmpty()) {
            return Result.error(ErrorCode.PARAM_ERROR);
        }

        log.info("生成 AI 功能代码: featureCount={}", aiFeaturesData.size());

        try {
            // 将 Map 列表转换为 AIFeature 列表
            List<AINativeService.AIFeature> aiFeatures = convertToAIFeatures(aiFeaturesData);
            AINativeService.AICodeResult result = aiNativeService.generateAICode(aiFeatures);
            return Result.success(result);
        } catch (Exception e) {
            log.error("生成 AI 功能代码失败", e);
            return Result.error(ErrorCode.SYSTEM_ERROR.getCode(), "生成 AI 功能代码失败: " + e.getMessage());
        }
    }

    /**
     * 调用 MCP 服务
     * 通过 MCP 协议调用外部 AI 服务
     *
     * @param request 包含 server, tool, params 的请求
     * @return MCP 响应
     */
    @PostMapping("/mcp/call")
    public Result<AINativeService.MCPResponse> callMCP(@Valid @RequestBody Map<String, Object> request) {
        String server = (String) request.get("server");
        String tool = (String) request.get("tool");
        @SuppressWarnings("unchecked")
        Map<String, Object> params = (Map<String, Object>) request.get("params");

        if (server == null || server.isBlank() || tool == null || tool.isBlank()) {
            return Result.error(ErrorCode.PARAM_ERROR);
        }

        log.info("调用 MCP 服务: server={}, tool={}", server, tool);

        try {
            AINativeService.MCPResponse response = aiNativeService.callMCP(server, tool, params);
            return Result.success(response);
        } catch (Exception e) {
            log.error("调用 MCP 服务失败", e);
            return Result.error(ErrorCode.SYSTEM_ERROR.getCode(), "调用 MCP 服务失败: " + e.getMessage());
        }
    }

    /**
     * 转换 Map 列表为 AIFeature 列表
     */
    @SuppressWarnings("unchecked")
    private List<AINativeService.AIFeature> convertToAIFeatures(List<Map<String, Object>> aiFeaturesData) {
        return aiFeaturesData.stream().map(data -> {
            AINativeService.AIFeature feature = new AINativeService.AIFeature();
            feature.setId((String) data.get("id"));
            feature.setType((String) data.get("type"));
            feature.setName((String) data.get("name"));
            feature.setModel((String) data.get("model"));
            feature.setPrompt((String) data.get("prompt"));

            // 转换 components
            if (data.get("components") != null) {
                List<Map<String, Object>> componentsData = (List<Map<String, Object>>) data.get("components");
                List<AINativeService.ComponentConfig> components = componentsData.stream().map(compData -> {
                    AINativeService.ComponentConfig config = new AINativeService.ComponentConfig();
                    config.setType((String) compData.get("type"));
                    config.setProps((Map<String, Object>) compData.get("props"));
                    config.setStyle((Map<String, Object>) compData.get("style"));
                    return config;
                }).toList();
                feature.setComponents(components);
            }

            // 转换 mcp
            if (data.get("mcp") != null) {
                Map<String, Object> mcpData = (Map<String, Object>) data.get("mcp");
                AINativeService.MCPConfig mcp = new AINativeService.MCPConfig();
                mcp.setServer((String) mcpData.get("server"));
                mcp.setTools((List<String>) mcpData.get("tools"));
                mcp.setParams((Map<String, Object>) mcpData.get("params"));
                feature.setMcp(mcp);
            }

            // 转换 apiConfig
            if (data.get("apiConfig") != null) {
                Map<String, Object> apiData = (Map<String, Object>) data.get("apiConfig");
                AINativeService.APIConfig apiConfig = new AINativeService.APIConfig();
                apiConfig.setEndpoint((String) apiData.get("endpoint"));
                apiConfig.setMethod((String) apiData.get("method"));
                apiConfig.setHeaders((Map<String, String>) apiData.get("headers"));
                if (apiData.get("auth") != null) {
                    Map<String, Object> authData = (Map<String, Object>) apiData.get("auth");
                    AINativeService.AuthConfig auth = new AINativeService.AuthConfig();
                    auth.setType((String) authData.get("type"));
                    auth.setToken((String) authData.get("token"));
                    apiConfig.setAuth(auth);
                }
                feature.setApiConfig(apiConfig);
            }

            return feature;
        }).toList();
    }
}

