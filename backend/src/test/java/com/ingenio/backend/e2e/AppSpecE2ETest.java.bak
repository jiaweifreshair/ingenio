package com.ingenio.backend.e2e;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ingenio.backend.entity.AppSpecEntity;
import com.ingenio.backend.entity.UserEntity;
import com.ingenio.backend.mapper.AppSpecMapper;
import com.ingenio.backend.mapper.UserMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MvcResult;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;
import static org.hamcrest.Matchers.*;
import static org.junit.jupiter.api.Assertions.*;

/**
 * AppSpecController E2E测试
 *
 * 测试场景：
 * 1. 创建AppSpec（成功和失败场景）
 * 2. 查询AppSpec详情
 * 3. 更新AppSpec状态
 * 4. 删除AppSpec（软删除）
 * 5. 分页查询AppSpec列表
 * 6. 创建AppSpec新版本
 *
 * 测试策略：
 * - 使用真实PostgreSQL数据库（TestContainers）
 * - 零Mock策略：使用真实Service和Mapper
 * - 每个测试前初始化测试数据
 * - 验证数据库状态确保正确性
 *
 * @author Ingenio Team
 * @since 1.0.0
 */
@DisplayName("AppSpec管理API E2E测试")
public class AppSpecE2ETest extends BaseE2ETest {

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private AppSpecMapper appSpecMapper;

    @Autowired
    private ObjectMapper objectMapper;

    private UUID testUserId;
    private UUID testTenantId;
    private UUID testAppSpecId;

    /**
     * 每个测试前初始化测试数据
     */
    @Override
    @BeforeEach
    public void setUp() {
        super.setUp();

        // 创建测试租户ID和用户ID
        testTenantId = UUID.randomUUID();
        long timestamp = System.currentTimeMillis();

        // 创建测试用户（满足外键约束）
        UserEntity testUser = UserEntity.builder()
            .tenantId(testTenantId.toString())
            .username("test-appspec-user-" + timestamp)
            .email("test-appspec-" + timestamp + "@ingenio.test")
            .passwordHash("test-password-hash")
            .createdAt(LocalDateTime.now())
            .updatedAt(LocalDateTime.now())
            .build();
        userMapper.insert(testUser);
        testUserId = testUser.getId();

        // 创建测试AppSpec
        testAppSpecId = UUID.randomUUID();
        Map<String, Object> specContent = new HashMap<>();
        specContent.put("pages", Map.of("home", Map.of("title", "首页", "components", "Button,Text")));
        specContent.put("dataModels", Map.of("User", Map.of("fields", "id,name,email")));

        AppSpecEntity appSpec = AppSpecEntity.builder()
            .id(testAppSpecId)
            .tenantId(testTenantId)
            .createdByUserId(testUserId)
            .specContent(specContent)
            .version(1)
            .status(AppSpecEntity.Status.DRAFT.getValue())
            .qualityScore(0)
            .createdAt(LocalDateTime.now())
            .updatedAt(LocalDateTime.now())
            .build();
        appSpecMapper.insert(appSpec);
    }

    @Test
    @DisplayName("测试1: 创建AppSpec - 成功场景")
    public void testCreateAppSpec_Success() throws Exception {
        // 准备请求数据
        Map<String, Object> newSpecContent = new HashMap<>();
        newSpecContent.put("pages", Map.of("profile", Map.of("title", "个人中心")));
        newSpecContent.put("dataModels", Map.of("Post", Map.of("fields", "id,title,content")));

        Map<String, Object> requestBody = new HashMap<>();
        requestBody.put("specContent", newSpecContent);

        String requestJson = objectMapper.writeValueAsString(requestBody);

        // 执行POST请求
        MvcResult result = mockMvc.perform(post("/api/v1/appspecs")
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestJson))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.success").value(true))
                .andExpect(jsonPath("$.data.id").exists())
                .andExpect(jsonPath("$.data.version").value(1))
                .andExpect(jsonPath("$.data.status").value("draft"))
                .andReturn();

        // 提取创建的AppSpec ID
        String responseBody = result.getResponse().getContentAsString();
        Map<String, Object> responseMap = objectMapper.readValue(responseBody, Map.class);
        String appSpecId = ((Map<String, Object>) responseMap.get("data")).get("id").toString();

        // 验证数据库中记录已创建
        AppSpecEntity createdAppSpec = appSpecMapper.selectById(UUID.fromString(appSpecId));
        assertNotNull(createdAppSpec, "数据库中应存在创建的AppSpec记录");
        assertEquals("draft", createdAppSpec.getStatus());
        assertEquals(1, createdAppSpec.getVersion());
    }

    @Test
    @DisplayName("测试2: 创建AppSpec - 参数验证失败")
    public void testCreateAppSpec_InvalidRequest() throws Exception {
        // 准备空的请求体（缺少specContent字段）
        Map<String, Object> requestBody = new HashMap<>();
        String requestJson = objectMapper.writeValueAsString(requestBody);

        // 执行POST请求，期望返回400错误
        mockMvc.perform(post("/api/v1/appspecs")
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestJson))
                .andExpect(status().isBadRequest());
    }

    @Test
    @DisplayName("测试3: 查询AppSpec详情 - 成功场景")
    public void testGetAppSpec_Success() throws Exception {
        // 执行GET请求
        mockMvc.perform(get("/api/v1/appspecs/{id}", testAppSpecId)
                .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.id").value(testAppSpecId.toString()))
                .andExpect(jsonPath("$.data.version").value(1))
                .andExpect(jsonPath("$.data.status").value("draft"))
                .andExpect(jsonPath("$.data.specContent.pages.home.title").value("首页"));
    }

    @Test
    @DisplayName("测试4: 更新AppSpec状态 - 成功场景")
    public void testUpdateAppSpecStatus_Success() throws Exception {
        // 准备状态更新请求
        Map<String, String> statusRequest = new HashMap<>();
        statusRequest.put("status", "validated");

        String requestJson = objectMapper.writeValueAsString(statusRequest);

        // 执行PUT请求
        mockMvc.perform(put("/api/v1/appspecs/{id}/status", testAppSpecId)
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestJson))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200));

        // 验证数据库中状态已更新
        AppSpecEntity updatedAppSpec = appSpecMapper.selectById(testAppSpecId);
        assertEquals("validated", updatedAppSpec.getStatus(), "AppSpec状态应已更新为validated");
    }

    @Test
    @DisplayName("测试5: 删除AppSpec - 软删除成功")
    public void testDeleteAppSpec_Success() throws Exception {
        // 执行DELETE请求
        mockMvc.perform(delete("/api/v1/appspecs/{id}", testAppSpecId)
                .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.message").value("删除成功"));

        // 验证数据库中记录已被软删除（MyBatis-Plus逻辑删除）
        AppSpecEntity deletedAppSpec = appSpecMapper.selectById(testAppSpecId);
        assertNull(deletedAppSpec, "AppSpec应已被软删除，查询应返回null");
    }

    @Test
    @DisplayName("测试6: 创建AppSpec新版本 - 成功场景")
    public void testCreateAppSpecVersion_Success() throws Exception {
        // 准备新版本的specContent
        Map<String, Object> newVersionSpecContent = new HashMap<>();
        newVersionSpecContent.put("pages", Map.of(
            "home", Map.of("title", "首页V2", "components", "Button,Text,Image"),
            "profile", Map.of("title", "个人中心", "components", "Avatar,Form")
        ));
        newVersionSpecContent.put("dataModels", Map.of(
            "User", Map.of("fields", "id,name,email,avatar")
        ));

        Map<String, Object> requestBody = new HashMap<>();
        requestBody.put("specContent", newVersionSpecContent);

        String requestJson = objectMapper.writeValueAsString(requestBody);

        // 执行POST请求创建新版本
        MvcResult result = mockMvc.perform(post("/api/v1/appspecs/{id}/versions", testAppSpecId)
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestJson))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.version").value(2))
                .andExpect(jsonPath("$.data.parentVersionId").value(testAppSpecId.toString()))
                .andExpect(jsonPath("$.data.status").value("draft"))
                .andReturn();

        // 提取新版本ID
        String responseBody = result.getResponse().getContentAsString();
        Map<String, Object> responseMap = objectMapper.readValue(responseBody, Map.class);
        String newVersionId = ((Map<String, Object>) responseMap.get("data")).get("id").toString();

        // 验证数据库中新版本已创建
        AppSpecEntity newVersion = appSpecMapper.selectById(UUID.fromString(newVersionId));
        assertNotNull(newVersion, "新版本应已创建");
        assertEquals(2, newVersion.getVersion(), "版本号应为2");
        assertEquals(testAppSpecId, newVersion.getParentVersionId(), "父版本ID应正确");
        assertEquals("draft", newVersion.getStatus(), "新版本状态应为draft");
    }

    @Test
    @DisplayName("测试7: 分页查询AppSpec列表 - 成功场景")
    public void testListAppSpecs_Success() throws Exception {
        // 创建多个测试AppSpec
        for (int i = 1; i <= 5; i++) {
            UUID newAppSpecId = UUID.randomUUID();
            Map<String, Object> specContent = new HashMap<>();
            specContent.put("pages", Map.of("page" + i, Map.of("title", "页面" + i)));

            AppSpecEntity appSpec = AppSpecEntity.builder()
                .id(newAppSpecId)
                .tenantId(testTenantId)
                .createdByUserId(testUserId)
                .specContent(specContent)
                .version(1)
                .status(AppSpecEntity.Status.DRAFT.getValue())
                .qualityScore(0)
                .createdAt(LocalDateTime.now())
                .updatedAt(LocalDateTime.now())
                .build();
            appSpecMapper.insert(appSpec);
        }

        // 执行GET请求查询列表（第1页，每页10条）
        mockMvc.perform(get("/api/v1/appspecs")
                .param("current", "1")
                .param("size", "10")
                .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.records", hasSize(greaterThanOrEqualTo(5))))
                .andExpect(jsonPath("$.data.total", greaterThanOrEqualTo(5)))
                .andExpect(jsonPath("$.data.current").value(1))
                .andExpect(jsonPath("$.data.size").value(10));
    }

    @Test
    @DisplayName("测试8: 查询不存在的AppSpec - 错误处理")
    public void testGetNonExistentAppSpec() throws Exception {
        UUID nonExistentId = UUID.randomUUID();

        // 执行GET请求，期望返回错误
        mockMvc.perform(get("/api/v1/appspecs/{id}", nonExistentId)
                .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value("3001")) // APPSPEC_NOT_FOUND
                .andExpect(jsonPath("$.success").value(false));
    }
}
