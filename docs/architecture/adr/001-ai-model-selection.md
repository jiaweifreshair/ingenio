# ADR 001: AI模型选型决策

**状态**: 已接受 (Accepted)
**日期**: 2025-11-11
**决策者**: Ingenio团队

---

## 上下文

Ingenio项目需要集成AI能力，支持19种AI功能类型的代码生成。我们需要选择合适的AI模型提供商和具体模型，以满足以下需求：

1. **功能需求**：
   - 支持多模态理解（文本、图像、视频）
   - 高质量的代码生成能力
   - 支持中文理解和生成
   - 低延迟响应（<2秒）

2. **成本约束**：
   - API调用成本低（每万用户<$500/月）
   - 可扩展性强（支持10万+日活）

3. **技术约束**：
   - API稳定性高（99.9%可用性）
   - 国内访问速度快（<100ms延迟）
   - 完善的开发文档和SDK支持

---

## 决策

### 主要决策：选择阿里云通义千问（Qwen）作为首选AI模型

**具体选型**：
1. **Qwen-Max** - 用于文本生成、对话、知识抽取
2. **Qwen-VL-Max** - 用于视觉理解、视频分析、OCR
3. **通义万相（Wanx）** - 用于多模态内容生成

**备选方案**：Google Gemini 2.0 Flash（用于实时流处理）

---

## 理由

### 1. 成本优势

| AI提供商 | 模型 | 成本（每千tokens） | 相对成本 |
|---------|------|-------------------|---------|
| **阿里云通义千问** | Qwen-Max | ¥0.002 ($0.00028) | **基准** |
| OpenAI | GPT-4 Turbo | $0.01 | **35倍** |
| OpenAI | GPT-4o-mini | $0.00015 | **0.5倍** |
| Anthropic | Claude 3.5 Sonnet | $0.003 | **10倍** |
| Google | Gemini 2.0 Flash | $0.00125 | **4.5倍** |

**结论**：Qwen-Max成本仅为GPT-4的1/35，每月可节省数千美元。

### 2. 性能表现

#### 中文理解能力对比

| 模型 | C-Eval准确率 | CMMLU准确率 | SuperCLUE排名 |
|-----|-------------|-------------|-------------|
| **Qwen-Max** | **83.5%** | **82.3%** | **第1名** |
| GPT-4 | 69.9% | 71.0% | 第3名 |
| Claude 3.5 | 65.7% | 67.2% | 第5名 |
| Gemini 2.0 | 78.2% | 76.5% | 第2名 |

**结论**：Qwen-Max在中文理解任务上显著领先，适合中文用户场景。

#### API响应速度

| 模型 | 平均延迟（国内） | P95延迟 | P99延迟 |
|-----|----------------|---------|---------|
| **Qwen-Max** | **85ms** | **150ms** | **300ms** |
| GPT-4 | 350ms | 800ms | 1500ms |
| Claude 3.5 | 420ms | 950ms | 1800ms |
| Gemini 2.0 | 120ms | 250ms | 500ms |

**结论**：Qwen-Max国内访问速度最快，用户体验最佳。

### 3. 可用性保障

| 提供商 | SLA保证 | 月均可用性 | 故障恢复时间 |
|--------|---------|-----------|------------|
| **阿里云** | **99.95%** | **99.98%** | **<10分钟** |
| OpenAI | 99.9% | 99.92% | ~30分钟 |
| Anthropic | 99.0% | 99.5% | ~1小时 |
| Google | 99.9% | 99.94% | ~15分钟 |

**结论**：阿里云SLA保证最高，服务稳定性强。

### 4. 功能覆盖

| AI能力类型 | Qwen支持 | Gemini支持 | GPT-4支持 |
|-----------|---------|-----------|----------|
| 文本生成 | ✅ Qwen-Max | ✅ Gemini Pro | ✅ GPT-4 |
| 对话系统 | ✅ Qwen-Max | ✅ Gemini Pro | ✅ GPT-4 |
| 代码生成 | ✅ Qwen-Coder | ✅ Gemini Pro | ✅ GPT-4 |
| 图像理解 | ✅ Qwen-VL-Max | ✅ Gemini Vision | ✅ GPT-4V |
| 视频分析 | ✅ Qwen-VL-Max | ✅ Gemini 2.0 | ❌ |
| 实时流 | ⚠️ 有限 | ✅ Gemini 2.0 | ❌ |
| OCR | ✅ 阿里云OCR | ⚠️ 第三方 | ⚠️ 第三方 |
| 多模态生成 | ✅ 通义万相 | ⚠️ Imagen | ✅ DALL-E 3 |

**结论**：Qwen覆盖了除实时流外的所有能力，Gemini作为补充。

### 5. 开发者体验

| 维度 | Qwen | Gemini | GPT-4 |
|-----|------|--------|-------|
| 文档质量 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| SDK支持 | Java, Python, Go, Node.js | Python, Node.js | Python, Node.js |
| 社区支持 | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 调试工具 | DashScope控制台 | AI Studio | Playground |
| 中文文档 | ✅ 完善 | ⚠️ 部分 | ⚠️ 机翻 |

**结论**：Qwen提供完善的中文文档和多语言SDK支持。

---

## 决策细节

### 主要AI模型选型矩阵

| AI能力类型 | 首选模型 | 备选模型 | 选型理由 |
|-----------|---------|---------|---------|
| CHATBOT | Qwen-Max | Gemini Pro | 中文理解强，成本低 |
| VIDEO_ANALYSIS | Qwen-VL-Max | Gemini Vision | 多模态视频分析 |
| IMAGE_RECOGNITION | Qwen-VL-Max | Gemini Vision | 视觉识别精准 |
| KNOWLEDGE_GRAPH | Qwen-Max | Claude 3.5 | 文本理解能力强 |
| OCR_DOCUMENT | Qwen-VL-Max | 阿里云OCR | 一体化方案 |
| REALTIME_STREAM | **Gemini 2.0** | Qwen-Max | 独有实时能力 |
| PREDICTIVE_ANALYTICS | Qwen-Max | Gemini Pro | 数据分析能力 |
| MULTIMODAL_GENERATION | 通义万相 | DALL-E 3 | 中文prompt支持 |
| ANOMALY_DETECTION | Qwen-Max | Claude 3.5 | 模式识别准确 |

### 成本预算（月度，1万日活用户）

| AI能力类型 | 预估调用量 | 单次成本 | 月成本（USD） |
|-----------|----------|---------|-------------|
| CHATBOT | 300,000次 | ¥0.002 | $84 |
| VIDEO_ANALYSIS | 50,000次 | ¥0.007 | $50 |
| KNOWLEDGE_GRAPH | 100,000次 | ¥0.002 | $28 |
| OCR_DOCUMENT | 80,000次 | ¥0.001 | $11 |
| REALTIME_STREAM | 10,000分钟 | ¥0.003/分钟 | $42 |
| 其他能力 | - | - | $199 |
| **总计** | - | - | **$414/月** |

**投资回报率（ROI）**：
- 收入预期：$9,000/月（订阅+按量付费）
- 成本：$414/月
- ROI：**21.7倍**

---

## 实施计划

### Phase 1: 核心能力集成（2周）
- [ ] 集成Qwen-Max（文本生成、对话）
- [ ] 集成Qwen-VL-Max（图像、视频）
- [ ] 实现基础的错误处理和重试机制
- [ ] 单元测试覆盖率≥85%

### Phase 2: 高级能力集成（2周）
- [ ] 集成通义万相（多模态生成）
- [ ] 集成Gemini 2.0（实时流处理）
- [ ] 实现多模型降级策略
- [ ] E2E测试覆盖率100%

### Phase 3: 性能优化（1周）
- [ ] 实现请求缓存（Redis）
- [ ] 并发调用优化
- [ ] 成本监控仪表盘
- [ ] 负载测试和压力测试

---

## 风险和缓解措施

### 风险1：API稳定性问题

**风险描述**：阿里云API可能出现故障或限流

**缓解措施**：
1. **多云备份**：集成Google Gemini作为备选
2. **熔断机制**：失败率>50%时自动切换
3. **请求重试**：最多重试3次，指数退避
4. **降级策略**：使用缓存或通用模板

### 风险2：成本超支

**风险描述**：用户量增长导致API调用成本激增

**缓解措施**：
1. **用量监控**：实时监控每小时成本
2. **配额限制**：单用户每日调用上限
3. **缓存策略**：相似请求返回缓存结果（节省30-40%）
4. **分层定价**：免费用户每日限额，付费用户无限制

### 风险3：模型幻觉（Hallucination）

**风险描述**：AI模型可能生成错误或无意义的代码

**缓解措施**：
1. **多次验证**：重要生成任务调用2-3次取最佳结果
2. **置信度阈值**：低于0.8的结果不返回
3. **人工审核**：复杂任务支持人工审核选项
4. **用户反馈**：收集用户反馈优化prompt

### 风险4：锁定风险（Vendor Lock-in）

**风险描述**：过度依赖阿里云生态，迁移成本高

**缓解措施**：
1. **统一接口**：抽象AIService接口，易于切换
2. **多模型支持**：同时集成2-3家提供商
3. **数据导出**：定期导出训练数据和模型参数
4. **本地模型**：长期规划部署本地模型（如Llama 3）

---

## 替代方案

### 方案A：全部使用OpenAI GPT-4

**优势**：
- 全球最强的语言模型
- 生态完善，社区支持好
- 多模态能力强

**劣势**：
- 成本极高（~$3,500/月，8.5倍差距）
- 国内访问慢（延迟>300ms）
- 中文理解不如Qwen

**决策**：❌ 拒绝（成本不可接受）

### 方案B：全部使用Google Gemini

**优势**：
- 性能优秀（尤其是实时流）
- 成本适中（~$1,850/月，4.5倍差距）
- 多模态能力强

**劣势**：
- 中文理解弱于Qwen
- 国内访问速度慢
- 部分功能还在测试阶段

**决策**：❌ 拒绝（中文能力不足）

### 方案C：混合使用Qwen + Gemini（最终选择）

**优势**：
- 成本最优（$414/月）
- 性能最佳（中文+实时流）
- 风险分散（多云备份）

**劣势**：
- 集成复杂度略高
- 需要维护两套SDK

**决策**：✅ 接受（综合最优）

---

## 后续评审计划

1. **3个月后评审**（2026-02-11）：
   - 评估实际成本和预算的偏差
   - 分析API稳定性和故障率
   - 收集用户反馈，评估模型质量

2. **6个月后评审**（2026-05-11）：
   - 对比新发布的模型（如GPT-5、Claude 4）
   - 评估本地模型的可行性（如Llama 3）
   - 决定是否调整模型选型

3. **12个月后全面评审**（2026-11-11）：
   - 综合评估一年来的表现
   - 决定是否续约或更换供应商
   - 制定下一年度的AI战略

---

## 相关文档

- [API成本估算表](../../../backend/docs/design/AI_CAPABILITIES_QUICK_REFERENCE.md)
- [AI模型性能对比报告](../../../backend/docs/testing/AI_MODEL_BENCHMARK.md)
- [多云架构设计](../MULTI_CLOUD_ARCHITECTURE.md)

---

**文档结束**
