'use client';

import { CheckCircle2, Circle, Loader2, XCircle } from 'lucide-react';
import { type AnalysisProgressMessage } from '@/hooks/use-analysis-sse';

/**
 * 分析进度展示面板
 *
 * 功能：
 * - 展示5个分析步骤的实时进度
 * - 支持步骤状态可视化：待处理、进行中、已完成、失败
 * - 显示每个步骤的详细描述和结果
 */
export interface AnalysisProgressPanelProps {
  messages: AnalysisProgressMessage[];
  isConnected: boolean;
  isCompleted: boolean;
  error: string | null;
}

const TOTAL_STEPS = 5;
const STEP_NAMES = [
  '需求解析',
  '实体建模',
  '关系识别',
  '技术选型',
  '复杂度评估'
];

export function AnalysisProgressPanel({
  messages,
  isConnected,
  isCompleted,
  error
}: AnalysisProgressPanelProps): React.ReactElement {
  /**
   * 获取步骤的最新状态
   */
  const getStepStatus = (step: number) => {
    const stepMessages = messages.filter(m => m.step === step);
    if (stepMessages.length === 0) {
      return { status: 'PENDING' as const, message: null };
    }
    const latest = stepMessages[stepMessages.length - 1];
    return { status: latest.status, message: latest };
  };

  /**
   * 渲染步骤图标
   */
  const renderStepIcon = (step: number) => {
    const { status } = getStepStatus(step);

    if (status === 'COMPLETED') {
      return <CheckCircle2 className="h-6 w-6 text-green-500" />;
    } else if (status === 'RUNNING') {
      return <Loader2 className="h-6 w-6 text-blue-500 animate-spin" />;
    } else if (status === 'FAILED') {
      return <XCircle className="h-6 w-6 text-red-500" />;
    } else {
      return <Circle className="h-6 w-6 text-gray-300" />;
    }
  };

  /**
   * 获取步骤颜色class
   */
  const getStepColorClass = (step: number) => {
    const { status } = getStepStatus(step);

    if (status === 'COMPLETED') {
      return 'border-green-500 bg-green-50 dark:bg-green-900/10';
    } else if (status === 'RUNNING') {
      return 'border-blue-500 bg-blue-50 dark:bg-blue-900/10';
    } else if (status === 'FAILED') {
      return 'border-red-500 bg-red-50 dark:bg-red-900/10';
    } else {
      return 'border-gray-200 dark:border-gray-700';
    }
  };

  /**
   * 计算整体进度百分比
   */
  const calculateProgress = () => {
    if (messages.length === 0) return 0;
    const latestProgress = messages[messages.length - 1]?.progress || 0;
    return latestProgress;
  };

  return (
    <div className="flex flex-col h-full">
      {/* 头部 */}
      <div className="mb-6">
        <h2 className="text-2xl font-bold mb-2">AI正在分析你的需求</h2>
        <p className="text-sm text-muted-foreground">
          {isCompleted
            ? '分析完成！正在为你生成应用...'
            : isConnected
            ? '正在实时分析中，请稍候...'
            : '等待连接...'}
        </p>

        {/* 整体进度条 */}
        <div className="mt-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium">整体进度</span>
            <span className="text-sm font-medium">{calculateProgress()}%</span>
          </div>
          <div className="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div
              className="h-full bg-gradient-to-r from-purple-600 to-blue-600 transition-all duration-500 ease-out"
              style={{ width: `${calculateProgress()}%` }}
            />
          </div>
        </div>
      </div>

      {/* 错误提示 */}
      {error && (
        <div className="mb-4 p-4 rounded-lg bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800">
          <div className="flex items-start gap-3">
            <XCircle className="h-5 w-5 text-red-500 flex-shrink-0 mt-0.5" />
            <div>
              <h3 className="font-semibold text-red-900 dark:text-red-100">分析失败</h3>
              <p className="text-sm text-red-700 dark:text-red-300">{error}</p>
            </div>
          </div>
        </div>
      )}

      {/* 步骤列表 */}
      <div className="flex-1 space-y-4 overflow-y-auto">
        {Array.from({ length: TOTAL_STEPS }, (_, i) => i + 1).map(step => {
          const { status, message } = getStepStatus(step);
          const stepName = STEP_NAMES[step - 1];

          return (
            <div
              key={step}
              className={`p-4 rounded-lg border-2 transition-all duration-300 ${getStepColorClass(step)}`}
            >
              <div className="flex items-start gap-3">
                {/* 步骤图标 */}
                <div className="flex-shrink-0 mt-0.5">{renderStepIcon(step)}</div>

                {/* 步骤内容 */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center justify-between mb-1">
                    <h3 className="font-semibold text-foreground">
                      Step {step}: {stepName}
                    </h3>
                    {message && (
                      <span className="text-xs text-muted-foreground">
                        {message.progress}%
                      </span>
                    )}
                  </div>

                  {/* 步骤描述 */}
                  {message && (
                    <p className="text-sm text-muted-foreground mb-2">
                      {message.description}
                    </p>
                  )}

                  {/* 步骤结果（已完成时显示） */}
                  {status === 'COMPLETED' && message?.result && (
                    <div className="mt-2 p-2 rounded bg-white/50 dark:bg-black/20 text-xs">
                      <div className="flex flex-wrap gap-2">
                        {Object.entries(message.result as Record<string, unknown>).map(
                          ([key, value]) => (
                            <span
                              key={key}
                              className="inline-flex items-center gap-1 px-2 py-1 rounded bg-primary/10 text-primary"
                            >
                              <strong>{key}:</strong> {typeof value === 'object' && value !== null ? JSON.stringify(value) : String(value)}
                            </span>
                          )
                        )}
                      </div>
                    </div>
                  )}

                  {/* 错误信息 */}
                  {status === 'FAILED' && message?.error && (
                    <p className="text-sm text-red-600 dark:text-red-400 mt-2">
                      ❌ {message.error}
                    </p>
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* 完成提示 */}
      {isCompleted && !error && (
        <div className="mt-6 p-4 rounded-lg bg-green-50 dark:bg-green-900/10 border border-green-200 dark:border-green-800">
          <div className="flex items-center gap-3">
            <CheckCircle2 className="h-5 w-5 text-green-500 flex-shrink-0" />
            <div>
              <h3 className="font-semibold text-green-900 dark:text-green-100">
                分析完成！
              </h3>
              <p className="text-sm text-green-700 dark:text-green-300">
                AI已充分理解你的需求，正在生成应用代码...
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
